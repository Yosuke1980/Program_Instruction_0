# 番組表自動生成システム - 関数解析ドキュメント

## 概要
番組表自動生成システムは、Google Sheets上の週別番組データを読み込み、構造化されたJSON形式に変換して、番組表・転置テーブル・ドキュメントを自動生成するWebアプリケーションです。

## 処理の全体フロー

```
メイン処理フロー
├── 1. データ取得段階
│   ├── getTargetSheet() - 対象シート取得
│   └── extractStructuredWeekData() - 週データ抽出
├── 2. 番組別データ抽出段階
│   ├── extractProgramData() - 番組データ分離
│   └── validateProgramData() - データ検証
├── 3. JSON変換段階
│   ├── convertWeekDataToJSON() - 週データJSON変換
│   ├── convertEpisodesToJSON() - エピソードデータ変換
│   └── convertDayDataToEpisode() - 曜日データ変換
├── 4. 番組表生成段階
│   ├── generateTransposeTable() - 転置テーブル生成
│   ├── generateTransposedTableData() - 表データ構築
│   └── convertToTransposedTable() - HTML変換
└── 5. ドキュメント出力段階
    ├── generateDocument() - ドキュメント生成
    └── 楽曲データベース連携処理
```

## 各段階の詳細解説

### 1. データ取得段階

#### `extractStructuredWeekData(sheet)` - 週データ抽出メイン関数
- **目的**: Google Sheetsから番組データを構造化された形で抽出
- **入力**: `sheet` (Google Sheetsオブジェクト)
- **出力**: 番組別・曜日別に整理されたデータオブジェクト
- **処理内容**:
  1. シートの全データを取得
  2. 番組マーカー行（RS行、New!Friday行など）を検出
  3. 各番組の曜日別データ範囲を特定
  4. 番組別データオブジェクトを構築

#### マーカー行検出処理
- **RS行検出**: `findRowsWithPatternInColumn()` で「RS」パターンを検索
- **New!Friday行検出**: 金曜日番組の開始位置特定
- **TheBurn行検出**: 金曜日番組の終了位置特定
- **曜日範囲計算**: 各曜日のデータ開始・終了行を算出

#### 曜日別データ構造
```javascript
{
  monday: { [番組名]: { 日付: [], 楽曲: [], ゲスト: [], ... } },
  tuesday: { [番組名]: { ... } },
  // ... 他曜日
}
```

### 2. 番組別データ抽出段階

#### `extractProgramData(programWeekData, programName)` - 番組データ分離
- **目的**: 週データから特定番組のデータのみを抽出
- **入力**:
  - `programWeekData`: 週全体のデータ
  - `programName`: 対象番組名
- **出力**: 番組の曜日別データオブジェクト
- **処理内容**:
  1. 曜日マッピング定義（english → japanese）
  2. 各曜日から対象番組データを抽出
  3. 日本語曜日キーでデータを再構成

#### 曜日キーマッピング
```javascript
const dayMapping = {
  'monday': '月曜',
  'tuesday': '火曜',
  'wednesday': '水曜',
  'thursday': '木曜',
  'friday': '金曜',
  'saturday': '土曜',
  'sunday': '日曜'
};
```

#### `validateProgramData(programName, programData)` - データ検証
- **目的**: 番組データの妥当性をチェック
- **処理内容**:
  1. 必須フィールドの存在確認
  2. データ型の検証
  3. 曜日データの整合性チェック

### 3. JSON変換段階

#### `convertWeekDataToJSON(weekData)` - 週データJSON変換
- **目的**: 週データを洗練されたJSON構造に変換
- **入力**: `weekData` (WeekData型)
- **出力**: `ProgramDataJSON` 型のオブジェクト
- **処理フロー**:
  1. 期間情報の設定
  2. 共通通知の生成
  3. 番組データの変換
  4. メタデータの付加

#### `convertEpisodesToJSON(programData, startDate)` - エピソード変換
- **目的**: 番組の曜日別データをエピソード形式に変換
- **重要な修正点**: 日本語曜日キー対応
- **処理内容**:
  1. 日本語曜日キー配列の定義
  2. 各曜日データの存在確認
  3. 日付計算とエピソード生成
  4. エピソード配列の構築

```javascript
// 修正後のキー設定
const japaneseDayKeys = ['月曜', '火曜', '水曜', '木曜', '金曜', '土曜', '日曜'];
const englishDayKeys = ['monday', 'tuesday', 'wednesday', 'thursday', 'friday', 'saturday', 'sunday'];
```

#### `convertDayDataToEpisode(dayData, date, dayKey)` - 曜日データ変換
- **目的**: 単一曜日のデータをエピソード形式に変換
- **入力**:
  - `dayData`: 曜日のデータ
  - `date`: 日付オブジェクト
  - `dayKey`: 曜日キー（英語）
- **出力**: エピソードオブジェクト
- **処理内容**:
  1. 日付の文字列化
  2. 曜日の日本語変換
  3. 各種データフィールドの抽出・変換

### 4. 番組表生成段階

#### `generateTransposeTable(programName, weekType)` - 転置テーブル生成メイン
- **目的**: 番組別詳細データを転置テーブル形式で生成
- **入力**:
  - `programName`: 番組名
  - `weekType`: 週タイプ（'thisWeek', 'nextWeek', 'nextWeek2', 'nextWeek3'）
- **出力**: TransposedTableData型のオブジェクト
- **処理フロー**:
  1. 入力パラメータの検証とサニタイズ
  2. 週タイプから週番号への変換
  3. 指定週のデータ取得
  4. 番組データの抽出
  5. 転置テーブルデータ構造の生成
  6. エラーハンドリングとデバッグログ記録

#### `generateTransposedTableData(programData, programName)` - 表データ構築
- **目的**: 転置テーブル用のデータ構造を生成
- **処理内容**:
  1. 番組別項目定義の取得
  2. 利用可能曜日の抽出・ソート
  3. 各曜日の日付データ検証
  4. ヘッダー行の生成（"8/26月曜"形式）
  5. 各項目の行データ生成

#### `convertToTransposedTable(programData, programName)` - HTML変換
- **目的**: 転置テーブルデータをHTMLテーブルに変換
- **処理内容**:
  1. HTMLテーブルヘッダーの生成
  2. 各項目行の生成（項目名を縦軸、日付を横軸）
  3. 項目データの取得と表示形式への変換

### 5. 番組別項目定義

#### `getProgramItems(programName)` - 番組項目定義
- **目的**: 各番組に特化した表示項目リストを返却
- **処理**: switch文による番組別分岐

##### ちょうどいいラジオ（9項目）
```javascript
[
  '７：２８パブ告知',
  '時間指定なし告知',
  'YOKOHAMA PORTSIDE INFORMATION',
  '指定曲',
  '先行予約',
  'ゲスト',
  '６：４５ラジオショッピング',
  '８：２９はぴねすくらぶ',
  '収録予定'
]
```

##### PRIME TIME（8項目）
```javascript
[
  '１９：４３パブリシティ',
  '２０：５１パブリシティ',
  '営業コーナー',
  '指定曲',
  'ゲスト',
  '時間指定なしパブ',
  'ラジショピ',
  '先行予約'
]
```

##### FLAG（9項目）
```javascript
[
  '１２：４０電話パブ',
  '１３：２９パブリシティ',
  '１３：４０パブリシティ',
  '１２：１５リポート案件',
  '１４：２９リポート案件',
  '時間指定なし告知',
  '楽曲',
  '先行予約',
  '収録予定'
]
```

##### その他番組
- **God Bless Saturday**: 4項目（キリンパークシティーヨコハマ等）
- **Route 847**: 4項目（16:47パブ、17:41パブ等）

### 6. 楽曲データベース連携機能

#### `getMusicData()` - 楽曲データベース読み込み
- **目的**: 専用楽曲データベースから楽曲情報を取得
- **処理フロー**:
  1. 楽曲データベーススプレッドシートにアクセス
  2. 必要列の自動検出（曲名、アーティスト、URL）
  3. データオブジェクトの生成とフィルタリング

#### `searchMusicData(musicDatabase, searchText)` - 高精度楽曲検索
- **目的**: 5段階の高度検索アルゴリズムで楽曲を検索
- **検索アルゴリズム**:
  1. **第1段階**: 曲名での前方一致検索
  2. **第2段階**: アーティスト名での前方一致検索
  3. **第3段階**: 逆検索（曲名）
  4. **第4段階**: 逆検索（アーティスト名）
  5. **第5段階**: 部分検索（複数単語対応）

#### `splitMusicData(content, musicDatabase)` - 楽曲データ分割・拡張
- **目的**: 番組表の楽曲データを個別楽曲に分割し、データベース検索で情報拡張
- **処理フロー**:
  1. 入力データ検証
  2. オブジェクト型・文字列型データの分別処理
  3. ♪マークでの分割処理
  4. `processMusicText()` による楽曲テキスト処理

## 関数依存関係図

```
extractUnifiedWeekData()
│
├─ getTargetSheet()
├─ extractStructuredWeekData()
│   ├─ findRowsWithPatternInColumn()
│   ├─ findFridayMarkers()
│   └─ calculateDayRanges()
├─ convertWeekDataToJSON()
│   ├─ generateCommonNotices()
│   ├─ convertProgramsToJSON()
│   │   ├─ convertSingleProgramToJSON()
│   │   │   ├─ convertEpisodesToJSON()
│   │   │   │   └─ convertDayDataToEpisode()
│   │   │   └─ extractRecordingsFromProgram()
│   │   └─ validateProgramData()
│   └─ extractWeeklyNotices()
├─ generateTransposeTable()
│   ├─ mapWeekTypeToNumber()
│   ├─ extractWeekByNumber()
│   ├─ extractProgramData()
│   └─ generateTransposedTableData()
│       ├─ getProgramItems()
│       ├─ formatDateWithDay()
│       └─ getEpisodeItemValue()
└─ 楽曲データベース連携
    ├─ getMusicData()
    │   ├─ getSongMusicConfig()
    │   ├─ findColumnIndex()
    │   └─ cleanMusicText()
    ├─ searchMusicData()
    ├─ splitMusicData()
    │   ├─ processMusicText()
    │   └─ cleanMusicObject()
    └─ 各種フォーマット関数群
```

## データフロー

### 1. データ入力
```
Google Sheets (週別シート) → 生データ (番組×曜日のマトリックス)
楽曲データベーススプレッドシート → 楽曲メタデータ
```

### 2. データ変換
```
生データ → 構造化データ (番組別・曜日別)
英語曜日キー → 日本語曜日キー (monday → 月曜)
曜日別データ → エピソード配列
項目データ → 表示用フォーマット
```

### 3. データ統合
```
番組データ + 楽曲DB → マストコメント付き楽曲情報
エピソード配列 + 項目定義 → 転置テーブルデータ
各番組データ → 統合JSON構造
```

### 4. 最終出力
```
JSON: {period, commonNotices, programs[]}
転置テーブル: {programName, headers[], rows[][]}
HTML: 表形式の番組詳細データ
```

## 重要な設定値・パラメータ

### Google Sheets 関連
- **シート名パターン**: `"YY.M.D-M.D"` 形式（例：25.9.08-9.14）
- **マーカー行**: "RS"、"New!Friday"、"TheBurn"
- **曜日範囲計算**: RSマーカーを基準とした相対位置計算

### 番組識別・分類
- **番組順序**: `['ちょうどいいラジオ', 'PRIME TIME', 'FLAG', 'God Bless Saturday', 'Route 847']`
- **曜日マッピング**: 英語↔日本語の双方向変換
- **データ検証**: 各番組の必須フィールド定義

### 楽曲データベース設定
- **メイン楽曲DB**: 曲名、アーティスト、URL列の自動検出
- **検索精度**: 5段階の検索アルゴリズム
- **クリーニング**: 特殊文字・番号記号の除去処理

### 週タイプマッピング
```javascript
const weekMapping = {
  'thisWeek': 1,
  'nextWeek': 2,
  'nextWeek2': 3,
  'nextWeek3': 4
};
```

## エラーハンドリング・デバッグ機能

### デバッグログパターン
- `[DEBUG]` - 処理段階の詳細情報
- `[CONVERT]` - データ変換処理
- `[ERROR]` - エラー・例外情報
- `[STEP N]` - 段階別処理ログ

### 主要なエラーケース
1. **シート取得失敗** → weekType検証とフォールバック処理
2. **番組データ不足** → validateProgramData() でのチェック
3. **曜日データ欠損** → 日本語キー対応とdefault値設定
4. **楽曲DB接続失敗** → ログ出力して処理継続
5. **JSON変換エラー** → 段階別エラー追跡とスタックトレース

### データ検証の各レイヤー
#### 1. 週データレベル
```javascript
if (!weekResults || Object.keys(weekResults).length === 0) {
  log('[ERROR] 週データが見つかりません');
  return {success: false, error: '指定週のデータが存在しません'};
}
```

#### 2. 番組データレベル
```javascript
const programData = extractProgramData(weekResults, programName);
if (!programData || Object.keys(programData).length === 0) {
  log('[ERROR] 番組データが見つかりません');
  return {success: false, error: '指定番組のデータが存在しません'};
}
```

#### 3. 曜日データレベル
```javascript
console.log(`[DEBUG] ${dayKey}のデータ検証: exists=${!!dayData}, type=${typeof dayData}`);
console.log(`[DEBUG] ${dayKey}の日付関連: hasDate=${dayData?.['日付'] ? true : false}`);
```

## パフォーマンス考慮点

### 効率化施策
1. **バッチ処理**: `getDataRange().getValues()` で一括データ取得
2. **メモリ最適化**: 必要なデータのみを保持
3. **キャッシュ利用**: 同一週データの再利用
4. **並列処理**: 独立した番組データの並行変換

### ボトルネック
1. **Google Sheets API**: 大量データ読み込み時の制限
2. **楽曲検索処理**: 線形検索による時間計算量 O(n)
3. **JSON変換**: 深いオブジェクト構造の処理時間
4. **HTML生成**: 大量データ時のDOM構築時間

### 最適化ポイント
- 楽曲検索のインデックス化検討
- データキャッシュ機能の実装
- 段階的データロード機能
- エラー時の部分データ利用

## 特殊な設計パターン

### 転置テーブル設計
- **従来**: 日付（縦）× 項目（横）
- **本システム**: 項目（縦）× 日付（横）
- **利点**: 多項目番組での横スクロール抑制、項目比較の容易さ

### 曜日キー二重管理
- **内部処理**: 日本語キー（月曜、火曜...）
- **外部API**: 英語キー（monday, tuesday...）
- **変換**: 両方向の自動変換機能

### 段階的データ変換
```
Raw Data → Structured Data → Validated Data → JSON Data → Display Data
```

## 関連ファイル・依存関係
- **src/01_config.ts**: システム設定・定数定義
- **src/02_types.ts**: TypeScript型定義
- **src/99_main.ts**: メイン処理ロジック
- **index.html**: フロントエンドUI・API呼び出し
- **改善点.txt**: 機能要件・改善項目
- **.clasp.json**: Google Apps Script プロジェクト設定

---

この番組表自動生成システムは、複雑な番組データ構造を効率的に処理し、多様な出力形式に対応する包括的なデータ変換プラットフォームです。各関数が連携してデータの整合性を保ちながら、高品質な番組表生成を実現しています。