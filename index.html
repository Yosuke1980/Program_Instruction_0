<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ラジオ番組ドキュメント自動生成</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            line-height: 1.6;
            color: #333;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2rem;
            margin-bottom: 10px;
            font-weight: 700;
        }

        .header p {
            opacity: 0.9;
            font-size: 1.1rem;
        }

        /* タブナビゲーション */
        .tab-nav {
            background: #f8fafc;
            border-bottom: 2px solid #e2e8f0;
            padding: 0;
        }

        .tab-nav ul {
            list-style: none;
            display: flex;
            margin: 0;
            padding: 0;
        }

        .tab-nav li {
            flex: 1;
        }

        .tab-nav button {
            width: 100%;
            padding: 15px 20px;
            border: none;
            background: transparent;
            color: #4a5568;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            border-bottom: 3px solid transparent;
        }

        .tab-nav button:hover {
            background: #edf2f7;
            color: #2d3748;
        }

        .tab-nav button.active {
            color: #667eea;
            background: white;
            border-bottom-color: #667eea;
        }

        /* タブコンテンツ */
        .tab-content {
            display: none;
            padding: 40px;
        }

        .tab-content.active {
            display: block;
        }

        /* 既存のスタイル（軽量化） */
        .program-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 25px;
            margin-bottom: 30px;
        }

        .program-card {
            background: #f8fafc;
            border: 2px solid #e2e8f0;
            border-radius: 15px;
            padding: 25px;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .program-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 4px;
            background: linear-gradient(90deg, #667eea, #764ba2);
        }

        .program-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.1);
            border-color: #667eea;
        }

        .program-title {
            font-size: 1.3rem;
            font-weight: 700;
            color: #2d3748;
            margin-bottom: 8px;
        }

        .program-description {
            color: #718096;
            font-size: 0.95rem;
            margin-bottom: 20px;
            line-height: 1.5;
        }

        .btn {
            width: 100%;
            padding: 12px 20px;
            border: none;
            border-radius: 10px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(102, 126, 234, 0.3);
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none !important;
        }

        .btn.loading {
            color: transparent;
        }

        .btn.loading::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 20px;
            height: 20px;
            border: 2px solid transparent;
            border-top: 2px solid white;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: translate(-50%, -50%) rotate(0deg); }
            100% { transform: translate(-50%, -50%) rotate(360deg); }
        }

        .bulk-actions {
            background: #f7fafc;
            border: 2px dashed #cbd5e0;
            border-radius: 15px;
            padding: 25px;
            text-align: center;
            margin-bottom: 30px;
        }

        .bulk-actions h3 {
            color: #2d3748;
            margin-bottom: 15px;
            font-size: 1.2rem;
        }

        .btn-secondary {
            background: #4a5568;
            color: white;
            margin: 0 10px;
            width: auto;
            padding: 10px 20px;
        }

        .btn-secondary:hover {
            background: #2d3748;
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(74, 85, 104, 0.3);
        }

        /* 結果表示セクション */
        .results-section {
            margin-top: 30px;
        }

        .results-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .results-title {
            font-size: 1.3rem;
            font-weight: 700;
            color: #2d3748;
        }

        .clear-btn {
            background: #e53e3e;
            color: white;
            padding: 8px 16px;
            border: none;
            border-radius: 8px;
            font-size: 0.9rem;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .clear-btn:hover {
            background: #c53030;
        }

        .results-container {
            background: #f7fafc;
            border-radius: 10px;
            padding: 20px;
            max-height: 400px;
            overflow-y: auto;
            border: 1px solid #e2e8f0;
        }

        .result-item {
            background: white;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 10px;
            border-left: 4px solid #48bb78;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        }

        .result-item.error {
            border-left-color: #e53e3e;
        }

        .result-timestamp {
            font-size: 0.85rem;
            color: #718096;
            margin-bottom: 8px;
        }

        .result-content {
            color: #2d3748;
            line-height: 1.5;
        }

        .result-content.error {
            color: #e53e3e;
        }

        .empty-results {
            text-align: center;
            color: #a0aec0;
            font-style: italic;
            padding: 40px 20px;
        }

        .program-status {
            font-size: 0.85rem;
            margin-top: 10px;
            padding: 8px 12px;
            border-radius: 6px;
            font-weight: 600;
        }

        .status-ready {
            background-color: #f0fff4;
            color: #276749;
            border: 1px solid #9ae6b4;
        }

        .status-processing {
            background-color: #fffaf0;
            color: #c05621;
            border: 1px solid #f6ad55;
        }

        .status-completed {
            background-color: #f0fff4;
            color: #276749;
            border: 1px solid #9ae6b4;
        }

        .status-failed {
            background-color: #fed7d7;
            color: #c53030;
            border: 1px solid #feb2b2;
        }

        .status-indicator {
            display: inline-block;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            margin-right: 8px;
        }

        .status-success {
            background-color: #48bb78;
        }

        .status-error {
            background-color: #e53e3e;
        }

        .status-loading {
            background-color: #ed8936;
            animation: pulse 1.5s ease-in-out infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        /* データ表示用スタイル */
        .data-controls {
            display: flex;
            gap: 20px;
            align-items: flex-end;
            justify-content: center;
            margin-bottom: 25px;
            flex-wrap: wrap;
        }

        .control-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .control-group label {
            font-weight: 600;
            color: #2d3748;
            font-size: 0.9rem;
        }

        .form-select {
            padding: 10px 12px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-size: 1rem;
            background: white;
            min-width: 180px;
            transition: all 0.3s ease;
        }

        .form-select:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .data-display {
            background: white;
            border-radius: 12px;
            border: 2px solid #e2e8f0;
            min-height: 300px;
            padding: 20px;
            overflow-x: auto;
        }

        .empty-data {
            display: flex;
            align-items: center;
            justify-content: center;
            height: 260px;
            color: #a0aec0;
            font-style: italic;
            text-align: center;
        }

        .loading-data {
            display: flex;
            align-items: center;
            justify-content: center;
            height: 260px;
            color: #667eea;
        }

        .loading-data::before {
            content: '';
            width: 20px;
            height: 20px;
            border: 2px solid #e2e8f0;
            border-top: 2px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-right: 10px;
        }

        .data-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
        }

        .data-table th,
        .data-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #e2e8f0;
        }

        .data-table th {
            background: #f7fafc;
            font-weight: 600;
            color: #2d3748;
            white-space: nowrap;
        }

        .data-table td {
            color: #4a5568;
            vertical-align: top;
        }

        .data-table tr:hover {
            background: #f7fafc;
        }

        /* 番組一覧表専用スタイル */
        .program-table th {
            cursor: pointer;
            user-select: none;
        }

        .program-table th:hover {
            background: #edf2f7;
        }

        .episode-details {
            padding: 20px;
            background: #f8f9fa;
            border-radius: 8px;
            margin: 10px 0;
        }

        .episode-table {
            margin-top: 10px;
            font-size: 0.9rem;
        }

        .episode-table th,
        .episode-table td {
            padding: 8px 12px;
        }

        .table-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            gap: 20px;
        }

        .table-filters {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .btn-sm {
            padding: 4px 8px;
            font-size: 0.8rem;
            border-radius: 4px;
        }

        .error-data {
            display: flex;
            align-items: center;
            justify-content: center;
            height: 200px;
            color: #e53e3e;
            background: #fed7d7;
            border-radius: 8px;
            text-align: center;
        }

        .data-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid #e2e8f0;
        }

        .data-title {
            font-size: 1.2rem;
            font-weight: 700;
            color: #2d3748;
        }

        .data-info {
            font-size: 0.9rem;
            color: #718096;
        }

        @media (max-width: 768px) {
            .container {
                margin: 10px;
                border-radius: 15px;
            }

            .header {
                padding: 25px 20px;
            }

            .header h1 {
                font-size: 1.6rem;
            }

            .tab-content {
                padding: 25px 20px;
            }

            .program-grid {
                grid-template-columns: 1fr;
                gap: 20px;
            }

            .bulk-actions {
                padding: 20px;
            }

            .btn-secondary {
                margin: 5px;
                width: calc(50% - 10px);
            }

            .data-controls {
                flex-direction: column;
                align-items: stretch;
            }

            .control-group {
                width: 100%;
            }

            .form-select {
                min-width: auto;
            }

            .data-table {
                min-width: 600px;
            }
        }

        /* デバッグ表示用スタイル */
        .debug-controls {
            display: flex;
            gap: 20px;
            align-items: flex-end;
            justify-content: center;
            margin-bottom: 25px;
            flex-wrap: wrap;
        }

        .debug-display {
            background: white;
            border-radius: 12px;
            border: 2px solid #e2e8f0;
            min-height: 400px;
            overflow: hidden;
        }

        .debug-header {
            background: #f7fafc;
            padding: 15px 20px;
            border-bottom: 2px solid #e2e8f0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .debug-title {
            font-weight: 600;
            color: #2d3748;
            font-size: 1rem;
        }

        .copy-btn {
            background: #667eea;
            color: white;
            padding: 6px 12px;
            border: none;
            border-radius: 6px;
            font-size: 0.85rem;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .copy-btn:hover {
            background: #5a67d8;
            transform: translateY(-1px);
        }

        .json-container {
            margin: 0;
            padding: 20px;
            font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
            font-size: 0.85rem;
            line-height: 1.6;
            background: white;
            color: #2d3748;
            max-height: 600px;
            overflow-y: auto;
            white-space: pre-wrap;
            word-wrap: break-word;
        }

        /* JSON シンタックスハイライト風 */
        .json-container .json-key {
            color: #d73a49;
            font-weight: 600;
        }

        .json-container .json-string {
            color: #032f62;
        }

        .json-container .json-number {
            color: #005cc5;
        }

        .json-container .json-boolean {
            color: #e36209;
        }

        .json-container .json-null {
            color: #6f42c1;
        }

        .json-container .json-bracket {
            color: #24292e;
            font-weight: bold;
        }

        .loading-json {
            display: flex;
            align-items: center;
            justify-content: center;
            height: 300px;
            color: #667eea;
        }

        .loading-json::before {
            content: '';
            width: 20px;
            height: 20px;
            border: 2px solid #e2e8f0;
            border-top: 2px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-right: 10px;
        }

        @media (max-width: 768px) {
            .debug-controls {
                flex-direction: column;
                align-items: stretch;
            }

            .json-container {
                font-size: 0.75rem;
                max-height: 400px;
            }

            .debug-header {
                padding: 12px 15px;
            }
        }
        
        /* メタデータ編集用スタイル */
        .metadata-controls {
            display: flex;
            gap: 20px;
            align-items: flex-end;
            justify-content: center;
            margin-bottom: 25px;
            flex-wrap: wrap;
        }
        
        .metadata-editor {
            background: white;
            border-radius: 12px;
            border: 2px solid #e2e8f0;
            padding: 30px;
            margin-bottom: 25px;
        }
        
        .metadata-display {
            background: white;
            border-radius: 12px;
            border: 2px solid #e2e8f0;
            min-height: 300px;
            padding: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .empty-metadata {
            color: #a0aec0;
            font-style: italic;
            text-align: center;
        }
        
        .form-section {
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 1px solid #e2e8f0;
        }
        
        .form-section:last-of-type {
            border-bottom: none;
        }
        
        .form-section h4 {
            color: #2d3748;
            margin-bottom: 15px;
            font-size: 1.1rem;
            font-weight: 600;
        }
        
        .form-section h5 {
            color: #4a5568;
            margin-bottom: 10px;
            font-size: 1rem;
            font-weight: 500;
        }
        
        .form-row {
            display: flex;
            gap: 20px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }
        
        .form-group {
            flex: 1;
            min-width: 250px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: #2d3748;
            font-size: 0.9rem;
        }
        
        .form-input {
            width: 100%;
            padding: 10px 12px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-size: 1rem;
            background: white;
            transition: all 0.3s ease;
        }
        
        .form-input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
        
        .form-textarea {
            width: 100%;
            padding: 10px 12px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-size: 1rem;
            background: white;
            transition: all 0.3s ease;
            resize: vertical;
            min-height: 80px;
            font-family: inherit;
        }
        
        .form-textarea:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
        
        .frame-type {
            margin-bottom: 20px;
            padding: 15px;
            background: #f7fafc;
            border-radius: 8px;
            border: 1px solid #e2e8f0;
        }
        
        .frame-item {
            margin-bottom: 10px;
            padding: 10px;
            background: white;
            border-radius: 6px;
            border: 1px solid #e2e8f0;
        }
        
        .frame-controls {
            display: flex;
            gap: 10px;
            align-items: center;
            flex-wrap: wrap;
        }
        
        .frame-input {
            flex: 1;
            min-width: 120px;
            padding: 8px 10px;
            border: 1px solid #cbd5e0;
            border-radius: 6px;
            font-size: 0.9rem;
        }
        
        .frame-select {
            flex: 1;
            min-width: 120px;
            padding: 8px 10px;
            border: 1px solid #cbd5e0;
            border-radius: 6px;
            font-size: 0.9rem;
        }
        
        .btn-add {
            padding: 8px 16px;
            background: #48bb78;
            color: white;
            border: none;
            border-radius: 6px;
            font-size: 0.9rem;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .btn-add:hover {
            background: #38a169;
            transform: translateY(-1px);
        }
        
        .btn-remove {
            padding: 6px 10px;
            background: #e53e3e;
            color: white;
            border: none;
            border-radius: 4px;
            font-size: 0.8rem;
            cursor: pointer;
            transition: all 0.3s ease;
            flex-shrink: 0;
        }
        
        .btn-remove:hover {
            background: #c53030;
        }
        
        .form-actions {
            display: flex;
            gap: 15px;
            padding-top: 20px;
            border-top: 1px solid #e2e8f0;
            margin-top: 20px;
        }
        
        .btn-danger {
            background: #e53e3e;
            color: white;
        }
        
        .btn-danger:hover {
            background: #c53030;
        }
        
        @media (max-width: 768px) {
            .metadata-controls {
                flex-direction: column;
                align-items: stretch;
            }
            
            .form-row {
                flex-direction: column;
                gap: 15px;
            }
            
            .form-group {
                min-width: auto;
            }
            
            .frame-controls {
                flex-direction: column;
                align-items: stretch;
            }
            
            .frame-input,
            .frame-select {
                min-width: auto;
            }
            
            .form-actions {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>📻 ラジオ番組ドキュメント自動生成</h1>
            <p>番組別にWordドキュメントを自動生成してメール送信します</p>
        </div>

        <!-- タブナビゲーション -->
        <div class="tab-nav">
            <ul>
                <li><button class="tab-button active" onclick="switchTab('generate')">ドキュメント生成</button></li>
                <li><button class="tab-button" onclick="switchTab('table')">番組別詳細表</button></li>
                <li><button class="tab-button" onclick="switchTab('dataflow')">データフロー分析</button></li>
            </ul>
        </div>

        <!-- タブ1: ドキュメント生成 -->
        <div id="tab-generate" class="tab-content active">
            <!-- 番組別実行セクション -->
            <div class="program-grid">
                <div class="program-card">
                    <div class="program-title">ちょうどいいラジオ</div>
                    <div class="program-description">翌週分のドキュメントを生成します（月～木放送）</div>
                    <button class="btn btn-primary" onclick="executeProgram('choudo')">
                        生成実行
                    </button>
                    <div class="program-status status-ready" id="status-choudo">
                        <span class="status-indicator status-success"></span>
                        実行待機中
                    </div>
                </div>

                <div class="program-card">
                    <div class="program-title">PRIME TIME</div>
                    <div class="program-description">翌週分のドキュメントを生成します（月～木放送）</div>
                    <button class="btn btn-primary" onclick="executeProgram('primetime')">
                        生成実行
                    </button>
                    <div class="program-status status-ready" id="status-primetime">
                        <span class="status-indicator status-success"></span>
                        実行待機中
                    </div>
                </div>

                <div class="program-card">
                    <div class="program-title">FLAG</div>
                    <div class="program-description">今週からの4週間分ドキュメントを生成します（金曜放送）</div>
                    <button class="btn btn-primary" onclick="executeProgram('flag')">
                        生成実行
                    </button>
                    <div class="program-status status-ready" id="status-flag">
                        <span class="status-indicator status-success"></span>
                        実行待機中
                    </div>
                </div>

                <div class="program-card">
                    <div class="program-title">Route 847</div>
                    <div class="program-description">今週分のドキュメントを生成します（土曜放送）</div>
                    <button class="btn btn-primary" onclick="executeProgram('route847')">
                        生成実行
                    </button>
                    <div class="program-status status-ready" id="status-route847">
                        <span class="status-indicator status-success"></span>
                        実行待機中
                    </div>
                </div>

                <div class="program-card">
                    <div class="program-title">God Bless Saturday</div>
                    <div class="program-description">今週分のドキュメントを生成します（土曜放送）</div>
                    <button class="btn btn-primary" onclick="executeProgram('godbless')">
                        生成実行
                    </button>
                    <div class="program-status status-ready" id="status-godbless">
                        <span class="status-indicator status-success"></span>
                        実行待機中
                    </div>
                </div>
            </div>

            <div class="bulk-actions">
                <h3>🚀 一括実行</h3>
                <button class="btn btn-secondary" onclick="executeAllPrograms()">
                    全番組実行
                </button>
                <button class="btn btn-secondary" onclick="testAllPrograms()">
                    テスト実行
                </button>
                <button class="btn btn-secondary" onclick="checkConfiguration()">
                    設定確認
                </button>
            </div>
        </div>


        <!-- タブ3: データフロー分析 -->
        <div id="tab-dataflow" class="tab-content">
            <div style="text-align: center; margin-bottom: 30px;">
                <h3 style="color: #2d3748; margin-bottom: 10px;">🔍 データフロー分析</h3>
                <p style="color: #718096;">各段階でのJSONデータの変換プロセスを確認できます</p>
            </div>

            <div class="data-controls">
                <div class="control-group">
                    <label for="dataflow-program-select">番組を選択:</label>
                    <select id="dataflow-program-select" class="form-select">
                        <option value="">番組を選択してください</option>
                        <option value="ちょうどいいラジオ">ちょうどいいラジオ</option>
                        <option value="PRIME TIME">PRIME TIME</option>
                        <option value="FLAG">FLAG</option>
                        <option value="God Bless Saturday">God Bless Saturday</option>
                        <option value="Route 847">Route 847</option>
                    </select>
                </div>
                <div class="control-group">
                    <label for="dataflow-week-select">対象週を選択:</label>
                    <select id="dataflow-week-select" class="form-select">
                        <option value="thisWeek">今週</option>
                        <option value="nextWeek">来週</option>
                    </select>
                </div>
                <div class="control-group">
                    <label for="dataflow-stage-select">分析段階:</label>
                    <select id="dataflow-stage-select" class="form-select">
                        <option value="all">全段階</option>
                        <option value="1-INPUT-SHEET">1. シート入力</option>
                        <option value="2-MARKERS-DETECTED">2. マーカー検出</option>
                        <option value="3-DATE-RANGES">3. 日付範囲計算</option>
                        <option value="4-STRUCTURED-PROGRAMS">4. 番組構造化</option>
                        <option value="5-FINAL-WEEK-DATA">5. 週データ最終形</option>
                        <option value="6-WEBAPP-INPUT">6. WebApp入力</option>
                        <option value="7-RAW-WEEK-DATA">7. 生週データ</option>
                        <option value="8-TRANSFORMED-WEEK-DATA">8. データ変換後</option>
                        <option value="9-WEBAPP-FINAL-OUTPUT">9. WebApp最終出力</option>
                    </select>
                </div>
            </div>
            
            <div style="display: flex; gap: 15px; justify-content: center; margin-bottom: 30px;">
                <button onclick="loadDataFlowAnalysis()" class="btn btn-primary">
                    データフロー実行・分析
                </button>
                <button onclick="clearDataFlowData()" class="btn btn-secondary">
                    データクリア
                </button>
                <button onclick="exportDebugData()" class="btn btn-secondary">
                    JSONエクスポート
                </button>
            </div>

            <div id="dataflow-display" class="data-display">
                <div class="empty-data">
                    上記で番組・週・段階を選択して「データフロー実行・分析」ボタンをクリックしてください
                </div>
            </div>
            
            <div id="dataflow-stage-summary" style="margin-top: 20px; display: none;">
                <div style="background: #f8f9fa; border-radius: 8px; padding: 20px;">
                    <h4 style="color: #2d3748; margin-bottom: 15px;">📊 段階別データサマリー</h4>
                    <div id="stage-summary-content"></div>
                </div>
            </div>
        </div>

        <!-- タブ4: 番組一覧表 -->
        <div id="tab-table" class="tab-content">
            <div style="text-align: center; margin-bottom: 30px;">
                <h3 style="color: #2d3748; margin-bottom: 10px;">📊 番組別詳細表</h3>
                <p style="color: #718096;">選択した番組の詳細データを表形式で確認できます</p>
            </div>

            <div class="table-controls">
                <div style="display: flex; gap: 20px; margin-bottom: 20px;">
                    <div class="control-group">
                        <label for="program-select-table" style="font-weight: 600; color: #2d3748; margin-bottom: 8px; display: block;">番組を選択:</label>
                        <select id="program-select-table" class="form-select" style="width: 300px;">
                            <option value="">番組を選択してください</option>
                            <option value="ちょうどいいラジオ">ちょうどいいラジオ</option>
                            <option value="PRIME TIME">PRIME TIME</option>
                            <option value="FLAG">FLAG</option>
                            <option value="God Bless Saturday">God Bless Saturday</option>
                            <option value="Route 847">Route 847</option>
                            <option value="CHOICES">CHOICES</option>
                        </select>
                    </div>
                    <div class="control-group">
                        <label for="week-select-table" style="font-weight: 600; color: #2d3748; margin-bottom: 8px; display: block;">対象週を選択:</label>
                        <select id="week-select-table" class="form-select" style="width: 200px;">
                            <option value="thisWeek">今週</option>
                            <option value="nextWeek">来週</option>
                            <option value="nextWeek2">2週先</option>
                            <option value="nextWeek3">3週先</option>
                        </select>
                    </div>
                </div>
                <button onclick="loadSingleProgramTable()" class="btn btn-primary">
                    番組詳細データを表示
                </button>
            </div>

            <div id="table-display" class="data-display">
                <div class="empty-data">
                    上記で番組を選択して「番組詳細データを表示」ボタンをクリックしてください
                </div>
            </div>
            
            <!-- デバッグログ表示エリア -->
            <div id="debug-log-section" style="margin-top: 20px; display: none;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                    <h4 style="margin: 0; color: #e53e3e;">🐛 デバッグログ</h4>
                    <button id="hide-debug-btn" onclick="hideDebugLog()" class="btn" style="background: #f56565; color: white; font-size: 0.8rem; padding: 5px 10px;">
                        ログを隠す
                    </button>
                </div>
                <div id="debug-log-content" style="background: #1a202c; color: #e2e8f0; padding: 15px; border-radius: 5px; font-family: monospace; font-size: 0.85rem; max-height: 400px; overflow-y: auto; white-space: pre-wrap;">
                </div>
            </div>
            
            <!-- デバッグログ表示ボタン -->
            <div id="debug-controls" style="margin-top: 15px; text-align: center; display: none;">
                <button id="show-debug-btn" onclick="showDebugLog()" class="btn" style="background: #4299e1; color: white; font-size: 0.9rem;">
                    🐛 デバッグログを表示
                </button>
            </div>
        </div>


        <!-- 実行結果セクション -->
        <div class="results-section">
            <div class="results-header">
                <div class="results-title">📋 実行結果</div>
                <button class="clear-btn" onclick="clearResults()">
                    クリア
                </button>
            </div>
            <div class="results-container" id="results">
                <div class="empty-results">
                    まだ実行結果がありません
                </div>
            </div>
        </div>
    </div>

    <script>
        // プログラム実行関数マッピング
        var programFunctions = {
            'choudo': 'webAppAutoGenerateChoudo',
            'primetime': 'webAppAutoGeneratePrimeTime', 
            'flag': 'webAppAutoGenerateFlag',
            'route847': 'webAppAutoGenerateRoute847',
            'godbless': 'webAppAutoGenerateGodBless'
        };

        var programNames = {
            'choudo': 'ちょうどいいラジオ',
            'primetime': 'PRIME TIME',
            'flag': 'FLAG', 
            'route847': 'Route 847',
            'godbless': 'God Bless Saturday'
        };

        // タブ切り替え
        function switchTab(tabName) {
            // 全タブを非表示
            var tabs = document.querySelectorAll('.tab-content');
            for (var i = 0; i < tabs.length; i++) {
                tabs[i].classList.remove('active');
            }
            
            // 全タブボタンを非アクティブ
            var buttons = document.querySelectorAll('.tab-button');
            for (var j = 0; j < buttons.length; j++) {
                buttons[j].classList.remove('active');
            }
            
            // 指定タブを表示
            document.getElementById('tab-' + tabName).classList.add('active');
            event.target.classList.add('active');
        }

        // 単一番組実行
        function executeProgram(programKey) {
            var button = event.target;
            var statusEl = document.getElementById('status-' + programKey);
            var functionName = programFunctions[programKey];
            var programName = programNames[programKey];

            button.disabled = true;
            button.classList.add('loading');
            updateStatus(programKey, 'processing', '実行中...');
            addResult(programName + 'の実行を開始しました', 'info');

            google.script.run
                .withSuccessHandler((result) => {
                    button.disabled = false;
                    button.classList.remove('loading');
                    updateStatus(programKey, 'completed', '実行完了');

                    if (result && result.success) {
                        addResult('✅ ' + programName + ': ドキュメント生成完了\nDocx送信: ' + (result.docxSent ? '成功' : '失敗'), 'success');
                        if (result.url) {
                            addResult('📄 ドキュメントURL: ' + result.url, 'info');
                        }
                    } else {
                        addResult('⚠️ ' + programName + ': 実行は完了しましたが、詳細は要確認', 'warning');
                        updateStatus(programKey, 'failed', '要確認');
                    }
                })
                .withFailureHandler((error) => {
                    button.disabled = false;
                    button.classList.remove('loading');
                    updateStatus(programKey, 'failed', '実行失敗');
                    addResult('❌ ' + programName + ': 実行エラー\n' + (error.message || error.toString()), 'error');
                })
                [functionName]();
        }

        // 全番組実行
        function executeAllPrograms() {
            addResult('🚀 全番組の一括実行を開始します', 'info');
            
            var programKeys = Object.keys(programFunctions);
            for (var k = 0; k < programKeys.length; k++) {
                (function(programKey, index) {
                    setTimeout(function() {
                        var button = document.querySelector('[onclick="executeProgram(\'' + programKey + '\')"]');
                        if (button && !button.disabled) {
                            button.click();
                        }
                    }, index * 2000);
                })(programKeys[k], k);
            }
        }

        // テスト実行
        function testAllPrograms() {
            addResult('🧪 テスト実行を開始します', 'info');
            
            google.script.run
                .withSuccessHandler(function(results) {
                    addResult('📊 テスト実行結果:', 'info');
                    for (var r = 0; r < results.length; r++) {
                        var result = results[r];
                        var status = result.success ? '✅' : '❌';
                        var docxStatus = result.docxSent ? ' (Docx送信成功)' : ' (Docx送信失敗)';
                        addResult(status + ' ' + result.program + ': ' + (result.success ? '成功' : result.error) + (result.success ? docxStatus : ''), result.success ? 'success' : 'error');
                    }
                })
                .withFailureHandler(function(error) {
                    addResult('❌ テスト実行エラー: ' + (error.message || error.toString()), 'error');
                })
                .webAppTestAllGeneration();
        }

        // 設定確認
        function checkConfiguration() {
            addResult('🔧 設定確認を開始します', 'info');
            
            google.script.run
                .withSuccessHandler(function(config) {
                    addResult('📋 設定確認結果:', 'info');
                    addResult('スプレッドシートID: ' + (config.hasSpreadsheetId ? '✅ 設定済み' : '❌ 未設定'), config.hasSpreadsheetId ? 'success' : 'error');
                    addResult('カレンダーID: ' + (config.hasCalendarId ? '✅ 設定済み' : '❌ 未設定'), config.hasCalendarId ? 'success' : 'error');
                    addResult('楽曲スプレッドシートID: ' + (config.hasMusicSpreadsheetId ? '✅ 設定済み' : '❌ 未設定'), config.hasMusicSpreadsheetId ? 'success' : 'error');
                    addResult('メールアドレス: ' + (config.hasEmailAddress ? '✅ 設定済み' : '❌ 未設定'), config.hasEmailAddress ? 'success' : 'error');
                    addResult('ドキュメントテンプレート: ' + (config.hasDocumentTemplates ? '✅ ' + config.templateCount + '件設定済み' : '❌ 未設定'), config.hasDocumentTemplates ? 'success' : 'error');
                    addResult('出力フォルダ: ' + (config.hasOutputFolder ? '✅ 設定済み' : '❌ 未設定'), config.hasOutputFolder ? 'success' : 'error');
                })
                .withFailureHandler(function(error) {
                    addResult('❌ 設定確認エラー: ' + (error.message || error.toString()), 'error');
                })
                .webAppGetConfigInfo();
        }

        // メタデータ編集関連関数
        let currentProgramMetadata = null;
        let isEditMode = false;
        
        function loadProgramMetadata() {
            const programSelect = document.getElementById('metadata-program-select');
            const programName = programSelect.value;
            
            if (!programName) {
                document.getElementById('metadata-editor').style.display = 'none';
                document.getElementById('metadata-display').innerHTML = '<div class="empty-metadata">番組を選択してメタデータを編集してください</div>';
                return;
            }
            
            addResult('📝 ' + programName + ' のメタデータを読み込み中...', 'info');
            
            google.script.run
                .withSuccessHandler((result) => {
                    if (result && result.success) {
                        const programData = result.data.programs.find(p => p.name === programName);
                        if (programData) {
                            currentProgramMetadata = programData;
                            populateMetadataForm(programData);
                            document.getElementById('metadata-editor').style.display = 'block';
                            document.getElementById('metadata-display').innerHTML = '';
                            addResult('✅ ' + programName + ' のメタデータ読み込み完了', 'success');
                        } else {
                            addResult('⚠️ ' + programName + ' のメタデータが見つかりません', 'warning');
                        }
                    } else {
                        addResult('❌ メタデータの取得に失敗しました', 'error');
                    }
                })
                .withFailureHandler((error) => {
                    addResult('❌ メタデータ取得エラー: ' + (error.message || error.toString()), 'error');
                })
                .webAppGetProgramMetadataAsJSONUnified();
        }

        function populateMetadataForm(programData) {
            document.getElementById('program-name').value = programData.name || '';
            document.getElementById('program-id').value = programData.programId || '';
            document.getElementById('production-company').value = programData.meta.productionCompany || '';
            document.getElementById('genre').value = programData.meta.genre || '';
            document.getElementById('start-date').value = programData.meta.startDate || '';
            document.getElementById('regular-slots').value = programData.meta.regularSlots ? programData.meta.regularSlots.join(', ') : '';
            document.getElementById('hosts').value = programData.meta.hosts ? programData.meta.hosts.join(', ') : '';
            document.getElementById('notes').value = programData.meta.notes ? programData.meta.notes.join(', ') : '';
            
            // フレーム情報をロード
            loadFrames('publicity', programData.meta.publicityFrames || []);
            loadFrames('report', programData.meta.reportFrames || []);
            loadFrames('call', programData.meta.callFrames || []);
            loadFrames('special', programData.meta.specialFrames || []);
            
            isEditMode = true;
        }

        function loadFrames(frameType, frames) {
            const container = document.getElementById(frameType + '-frames');
            container.innerHTML = '';
            
            frames.forEach((frame, index) => {
                addFrameElement(frameType, frame, index);
            });
        }

        function addFrame(frameType) {
            const frameData = getDefaultFrameData(frameType);
            const container = document.getElementById(frameType + '-frames');
            const index = container.children.length;
            addFrameElement(frameType, frameData, index);
        }
        
        function getDefaultFrameData(frameType) {
            switch(frameType) {
                case 'publicity':
                    return { time: '', allowedModes: [], label: '' };
                case 'report':
                case 'call':
                    return '';
                case 'special':
                    return { label: '', day: '' };
                default:
                    return {};
            }
        }
        
        function addFrameElement(frameType, frameData, index) {
            const container = document.getElementById(frameType + '-frames');
            const frameDiv = document.createElement('div');
            frameDiv.className = 'frame-item';
            frameDiv.dataset.index = index;
            
            let html = '';
            
            if (frameType === 'publicity') {
                html = `
                    <div class="frame-controls">
                        <input type="text" placeholder="時刻 (07:28)" value="${frameData.time || ''}" class="frame-input" data-field="time">
                        <input type="text" placeholder="ラベル" value="${frameData.label || ''}" class="frame-input" data-field="label">
                        <select multiple class="frame-select" data-field="allowedModes">
                            <option value="script" ${frameData.allowedModes && frameData.allowedModes.includes('script') ? 'selected' : ''}>原稿</option>
                            <option value="phone" ${frameData.allowedModes && frameData.allowedModes.includes('phone') ? 'selected' : ''}>電話</option>
                            <option value="report" ${frameData.allowedModes && frameData.allowedModes.includes('report') ? 'selected' : ''}>リポート</option>
                        </select>
                        <button type="button" class="btn-remove" onclick="removeFrame(this)">×</button>
                    </div>
                `;
            } else if (frameType === 'special') {
                html = `
                    <div class="frame-controls">
                        <input type="text" placeholder="ラベル" value="${frameData.label || ''}" class="frame-input" data-field="label">
                        <input type="text" placeholder="曜日 (オプション)" value="${frameData.day || ''}" class="frame-input" data-field="day">
                        <button type="button" class="btn-remove" onclick="removeFrame(this)">×</button>
                    </div>
                `;
            } else {
                html = `
                    <div class="frame-controls">
                        <input type="text" placeholder="${frameType === 'report' ? 'リポート' : 'コール'}フレーム情報" value="${frameData}" class="frame-input" data-field="value">
                        <button type="button" class="btn-remove" onclick="removeFrame(this)">×</button>
                    </div>
                `;
            }
            
            frameDiv.innerHTML = html;
            container.appendChild(frameDiv);
        }
        
        function removeFrame(button) {
            button.closest('.frame-item').remove();
        }

        // ステータス更新
        function updateStatus(programKey, status, text) {
            const statusEl = document.getElementById('status-' + programKey);
            const indicator = statusEl.querySelector('.status-indicator');
            
            statusEl.className = 'program-status';
            indicator.className = 'status-indicator';
            
            switch(status) {
                case 'processing':
                    statusEl.classList.add('status-processing');
                    indicator.classList.add('status-loading');
                    break;
                case 'completed':
                    statusEl.classList.add('status-completed');
                    indicator.classList.add('status-success');
                    break;
                case 'failed':
                    statusEl.classList.add('status-failed');
                    indicator.classList.add('status-error');
                    break;
                default:
                    statusEl.classList.add('status-ready');
                    indicator.classList.add('status-success');
            }
            
            statusEl.innerHTML = '<span class="' + indicator.className + '"></span>' + text;
        }

        // 結果表示
        function addResult(message, type) {
            type = type || 'info';
            const resultsContainer = document.getElementById('results');
            
            const emptyMessage = resultsContainer.querySelector('.empty-results');
            if (emptyMessage) {
                emptyMessage.remove();
            }

            const resultItem = document.createElement('div');
            resultItem.className = 'result-item' + (type === 'error' || type === 'warning' ? ' error' : '');
            
            const timestamp = new Date().toLocaleString('ja-JP');
            resultItem.innerHTML = '<div class="result-timestamp">' + timestamp + '</div><div class="result-content' + (type === 'error' ? ' error' : '') + '">' + message.replace(/\n/g, '<br>') + '</div>';

            resultsContainer.insertBefore(resultItem, resultsContainer.firstChild);
            resultsContainer.scrollTop = 0;
        }

        // 結果クリア
        function clearResults() {
            const resultsContainer = document.getElementById('results');
            resultsContainer.innerHTML = '<div class="empty-results">まだ実行結果がありません</div>';
        }
        
        function createNewProgram() {
            currentProgramMetadata = null;
            document.getElementById('metadata-program-select').value = '';
            
            // フォームをクリア
            document.getElementById('metadata-form').reset();
            
            // フレームをクリア
            ['publicity', 'report', 'call', 'special'].forEach(frameType => {
                document.getElementById(frameType + '-frames').innerHTML = '';
            });
            
            document.getElementById('metadata-editor').style.display = 'block';
            document.getElementById('metadata-display').innerHTML = '';
            isEditMode = false;
            
            addResult('📝 新規番組の作成モードです', 'info');
        }
        
        function saveMetadata() {
            const formData = collectFormData();
            
            if (!formData.name || !formData.programId) {
                addResult('⚠️ 番組名と番組IDは必須です', 'warning');
                return;
            }
            
            const action = isEditMode ? '更新' : '保存';
            addResult('💾 ' + formData.name + ' のメタデータを' + action + '中...', 'info');
            
            google.script.run
                .withSuccessHandler((result) => {
                    if (result && result.success) {
                        addResult('✅ ' + formData.name + ' のメタデータ' + action + 'が完了しました', 'success');
                        currentProgramMetadata = formData;
                        isEditMode = true;
                    } else {
                        addResult('❌ メタデータの' + action + 'に失敗しました', 'error');
                    }
                })
                .withFailureHandler((error) => {
                    addResult('❌ メタデータ' + action + 'エラー: ' + (error.message || error.toString()), 'error');
                })
                .webAppSaveProgramMetadata(formData);
        }
        
        function collectFormData() {
            const formData = {
                programId: document.getElementById('program-id').value,
                name: document.getElementById('program-name').value,
                meta: {
                    regularSlots: document.getElementById('regular-slots').value.split(',').map(s => s.trim()).filter(s => s),
                    hosts: document.getElementById('hosts').value.split(',').map(s => s.trim()).filter(s => s),
                    productionCompany: document.getElementById('production-company').value,
                    startDate: document.getElementById('start-date').value,
                    genre: document.getElementById('genre').value,
                    publicityFrames: collectFrameData('publicity'),
                    reportFrames: collectFrameData('report'),
                    callFrames: collectFrameData('call'),
                    specialFrames: collectFrameData('special'),
                    notes: document.getElementById('notes').value.split(',').map(s => s.trim()).filter(s => s)
                }
            };
            
            return formData;
        }
        
        function collectFrameData(frameType) {
            const container = document.getElementById(frameType + '-frames');
            const frames = [];
            
            Array.from(container.children).forEach(frameItem => {
                if (frameType === 'publicity') {
                    const time = frameItem.querySelector('[data-field="time"]').value;
                    const label = frameItem.querySelector('[data-field="label"]').value;
                    const allowedModesSelect = frameItem.querySelector('[data-field="allowedModes"]');
                    const allowedModes = Array.from(allowedModesSelect.selectedOptions).map(option => option.value);
                    
                    if (time || label || allowedModes.length > 0) {
                        frames.push({ time, label, allowedModes });
                    }
                } else if (frameType === 'special') {
                    const label = frameItem.querySelector('[data-field="label"]').value;
                    const day = frameItem.querySelector('[data-field="day"]').value;
                    
                    if (label) {
                        const frameData = { label };
                        if (day) frameData.day = day;
                        frames.push(frameData);
                    }
                } else {
                    const value = frameItem.querySelector('[data-field="value"]').value;
                    if (value) {
                        frames.push(value);
                    }
                }
            });
            
            return frames;
        }
        
        function cancelEdit() {
            document.getElementById('metadata-editor').style.display = 'none';
            document.getElementById('metadata-display').innerHTML = '<div class="empty-metadata">番組を選択してメタデータを編集してください</div>';
            document.getElementById('metadata-program-select').value = '';
            currentProgramMetadata = null;
            isEditMode = false;
            addResult('❌ 編集をキャンセルしました', 'info');
        }
        
        function deleteProgram() {
            if (!currentProgramMetadata) {
                addResult('⚠️ 削除する番組が選択されていません', 'warning');
                return;
            }
            
            if (!confirm(currentProgramMetadata.name + ' を削除しますか？')) {
                return;
            }
            
            addResult('🗑️ ' + currentProgramMetadata.name + ' を削除中...', 'info');
            
            google.script.run
                .withSuccessHandler((result) => {
                    if (result && result.success) {
                        addResult('✅ ' + currentProgramMetadata.name + ' の削除が完了しました', 'success');
                        cancelEdit();
                    } else {
                        addResult('❌ 番組の削除に失敗しました', 'error');
                    }
                })
                .withFailureHandler((error) => {
                    addResult('❌ 番組削除エラー: ' + (error.message || error.toString()), 'error');
                })
                .webAppDeleteProgramMetadata(currentProgramMetadata.programId);
        }

        // データ構造取得・表示機能（モード別）
        function loadSelectedProgramData() {
            const programSelect = document.getElementById('debug-program-select');
            const weekSelect = document.getElementById('debug-week-select');
            const modeSelect = document.getElementById('data-mode-select');
            const jsonOutput = document.getElementById('json-output');
            const copyBtn = document.getElementById('copy-json-btn');
            const loadButton = event.target;

            const programName = programSelect.value;
            const weekType = weekSelect.value;
            const dataMode = modeSelect.value;

            // メタデータモードの場合は番組選択不要
            if (!programName && dataMode !== 'metadata') {
                addResult('⚠️ 番組を選択してください', 'warning');
                return;
            }

            // ローディング状態にする
            loadButton.disabled = true;
            loadButton.classList.add('loading');
            jsonOutput.innerHTML = '<div class="loading-json">データ構造を取得中...</div>';
            copyBtn.style.display = 'none';

            const modeNames = {
                'raw': '生データ',
                'filtered': '番組フィルタ済み',
                'simplified': '簡素化データ',
                'rawprogram': '完全生データ',
                'metadata': '番組メタデータ'
            };

            // メタデータモードの場合は異なるメッセージ
            if (dataMode === 'metadata') {
                addResult('🔍 全番組の' + modeNames[dataMode] + 'を取得中...', 'info');
            } else {
                addResult('🔍 ' + programName + ' の' + (weekType === 'thisWeek' ? '今週' : '翌週') + '分' + modeNames[dataMode] + 'を取得中...', 'info');
            }

            // データモードに応じて適切なGAS関数を呼び出し
            let gasFunction;
            let gasParams = [programName, weekType];
            
            switch(dataMode) {
                case 'raw':
                    gasFunction = 'webAppGetProgramData';
                    break;
                case 'filtered':
                    gasFunction = 'webAppGetFilteredProgramData';
                    break;
                case 'simplified':
                    gasFunction = 'webAppGetSimplifiedProgramData';
                    break;
                case 'rawprogram':
                    gasFunction = 'webAppGetRawProgramDataUnfiltered';
                    break;
                case 'metadata':
                    gasFunction = 'webAppGetProgramMetadataAsJSONUnified';
                    gasParams = []; // メタデータは番組・週指定不要
                    break;
                default:
                    gasFunction = 'webAppGetProgramData';
            }

            // Google Apps Script関数を実行
            google.script.run
                .withSuccessHandler((result) => {
                    loadButton.disabled = false;
                    loadButton.classList.remove('loading');

                    if (result && result.success) {
                        displayJsonData(result, dataMode);
                        copyBtn.style.display = 'block';
                        
                        // メタデータモードの場合は異なる成功メッセージ
                        if (dataMode === 'metadata') {
                            addResult('✅ 全番組の' + modeNames[dataMode] + '取得完了 (' + (result.programCount || 0) + '番組)', 'success');
                        } else {
                            addResult('✅ ' + programName + ' の' + modeNames[dataMode] + '取得完了', 'success');
                        }
                    } else {
                        jsonOutput.innerHTML = 'データの取得に失敗しました\n\nエラー: ' + (result ? result.error || 'エラーの詳細が不明です' : '結果が返されませんでした');
                        
                        // メタデータモードの場合は異なるエラーメッセージ
                        if (dataMode === 'metadata') {
                            addResult('❌ 全番組の' + modeNames[dataMode] + '取得失敗: ' + (result ? result.error || '不明なエラー' : '結果が返されませんでした'), 'error');
                        } else {
                            addResult('❌ ' + programName + ' の' + modeNames[dataMode] + '取得失敗: ' + (result ? result.error || '不明なエラー' : '結果が返されませんでした'), 'error');
                        }
                    }
                })
                .withFailureHandler((error) => {
                    loadButton.disabled = false;
                    loadButton.classList.remove('loading');
                    jsonOutput.innerHTML = 'エラーが発生しました\n\n' + (error.message || error.toString());
                    addResult('❌ データ構造取得エラー: ' + (error.message || error.toString()), 'error');
                })
                [gasFunction](...gasParams);
        }
        
        // 後方互換性のための関数
        function loadFullProgramData() {
            loadSelectedProgramData();
        }

        // JSON データ表示
        function displayJsonData(result, dataMode = 'raw') {
            const jsonOutput = document.getElementById('json-output');
            
            let displayData;
            
            if (dataMode === 'simplified') {
                // 簡素化データの場合は構造を整理して表示
                displayData = {
                    programName: result.programName,
                    weekType: result.weekType,
                    simplified: result.simplified,
                    timestamp: result.timestamp,
                    data: result.data
                };
            } else if (dataMode === 'filtered') {
                // フィルタ済みデータの場合
                displayData = {
                    programName: result.programName,
                    weekType: result.weekType,
                    filtered: result.filtered,
                    sheetName: result.sheetName,
                    timestamp: result.timestamp,
                    weekResults: result.weekResults
                };
            } else if (dataMode === 'metadata') {
                // 番組メタデータの場合
                displayData = {
                    success: result.success,
                    timestamp: result.timestamp,
                    programCount: result.programCount,
                    data: result.data
                };
            } else if (dataMode === 'rawprogram') {
                // 完全生データの場合
                displayData = {
                    success: result.success,
                    programName: result.programName,
                    weekType: result.weekType,
                    sheetName: result.sheetName,
                    timestamp: result.timestamp,
                    rawProgramData: result.data
                };
            } else {
                // 生データの場合（従来通り）
                displayData = {
                    success: result.success,
                    programName: result.programName,
                    weekType: result.weekType,
                    sheetName: result.sheetName,
                    timestamp: result.timestamp,
                    data: result.data,
                    weekResults: result.weekResults,
                    rawResult: result
                };
            }
            
            // JSON文字列に変換（美しく整形）
            const jsonString = JSON.stringify(displayData, null, 2);
            
            // シンタックスハイライト風の表示
            const highlightedJson = syntaxHighlight(jsonString);
            jsonOutput.innerHTML = highlightedJson;
        }

        // JSON シンタックスハイライト
        function syntaxHighlight(json) {
            json = json.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
            return json.replace(/("(\\u[a-zA-Z0-9]{4}|\\[^u]|[^\\"])*"(\s*:)?|\b(true|false|null)\b|-?\d+(?:\.\d*)?(?:[eE][+\-]?\d+)?)/g, function (match) {
                var cls = 'json-number';
                if (/^"/.test(match)) {
                    if (/:$/.test(match)) {
                        cls = 'json-key';
                    } else {
                        cls = 'json-string';
                    }
                } else if (/true|false/.test(match)) {
                    cls = 'json-boolean';
                } else if (/null/.test(match)) {
                    cls = 'json-null';
                }
                return '<span class="' + cls + '">' + match + '</span>';
            });
        }

        // JSONをクリップボードにコピー
        function copyJsonToClipboard() {
            const jsonOutput = document.getElementById('json-output');
            const textToCopy = jsonOutput.textContent || jsonOutput.innerText;
            
            if (navigator.clipboard) {
                navigator.clipboard.writeText(textToCopy).then(() => {
                    addResult('📋 JSONデータをクリップボードにコピーしました', 'success');
                }).catch(() => {
                    addResult('❌ クリップボードへのコピーに失敗しました', 'error');
                });
            } else {
                // フォールバック
                const textArea = document.createElement('textarea');
                textArea.value = textToCopy;
                document.body.appendChild(textArea);
                textArea.select();
                try {
                    document.execCommand('copy');
                    addResult('📋 JSONデータをクリップボードにコピーしました', 'success');
                } catch (err) {
                    addResult('❌ クリップボードへのコピーに失敗しました', 'error');
                }
                document.body.removeChild(textArea);
            }
        }

        // 初期化
        document.addEventListener('DOMContentLoaded', function() {
            addResult('📻 ラジオ番組ドキュメント自動生成アプリが準備完了しました', 'info');
            
            setTimeout(function() {
                google.script.run
                    .withSuccessHandler(function(config) {
                        var allConfigured = config.hasSpreadsheetId && config.hasCalendarId && 
                                            config.hasEmailAddress && config.hasDocumentTemplates && 
                                            config.hasOutputFolder;
                        
                        if (allConfigured) {
                            addResult('✅ 基本設定は正常に構成されています', 'success');
                        } else {
                            addResult('⚠️ 一部の設定が不完全です。「設定確認」ボタンで詳細を確認してください', 'warning');
                        }
                    })
                    .withFailureHandler(function(error) {
                        addResult('⚠️ 初期設定確認でエラーが発生しました。設定を確認してください', 'warning');
                    })
                    .webAppGetConfigInfo();
            }, 1000);
        });

        // データフロー分析関数群
        function loadDataFlowAnalysis() {
            const programSelect = document.getElementById('dataflow-program-select');
            const weekSelect = document.getElementById('dataflow-week-select');
            const stageSelect = document.getElementById('dataflow-stage-select');
            
            const programName = programSelect.value;
            const weekType = weekSelect.value;
            const targetStage = stageSelect.value;
            
            if (!programName) {
                addResult('⚠️ 番組を選択してください', 'warning');
                return;
            }
            
            const dataflowDisplay = document.getElementById('dataflow-display');
            dataflowDisplay.innerHTML = '<div class="loading-data">データフロー実行中...</div>';
            
            // まず番組データを実行してデバッグデータを生成
            addResult('🔍 データフロー分析開始: ' + programName + ' (' + (weekType === 'thisWeek' ? '今週' : '来週') + ')', 'info');
            
            google.script.run
                .withSuccessHandler((result) => {
                    if (result && result.success) {
                        // 番組データの実行が完了したら、デバッグデータを取得
                        fetchDebugData(targetStage, programName, weekType);
                    } else {
                        dataflowDisplay.innerHTML = `<div class="error-data">データフロー実行エラー: ${result.error || '不明なエラー'}</div>`;
                        addResult('❌ データフロー実行に失敗しました', 'error');
                    }
                })
                .withFailureHandler((error) => {
                    dataflowDisplay.innerHTML = `<div class="error-data">実行エラー: ${error.message}</div>`;
                    addResult('❌ データフロー実行エラー: ' + (error.message || error.toString()), 'error');
                })
                .webAppGetProgramData(programName, weekType);
        }
        
        function fetchDebugData(targetStage, programName, weekType) {
            google.script.run
                .withSuccessHandler((debugResult) => {
                    if (debugResult && debugResult.success) {
                        displayDataFlowAnalysis(debugResult.data, targetStage, programName, weekType);
                        addResult('✅ データフロー分析完了: ' + debugResult.dataCount + '件のデバッグデータ', 'success');
                    } else {
                        const dataflowDisplay = document.getElementById('dataflow-display');
                        dataflowDisplay.innerHTML = `<div class="error-data">デバッグデータ取得エラー: ${debugResult.error || '不明なエラー'}</div>`;
                        addResult('❌ デバッグデータ取得に失敗しました', 'error');
                    }
                })
                .withFailureHandler((error) => {
                    const dataflowDisplay = document.getElementById('dataflow-display');
                    dataflowDisplay.innerHTML = `<div class="error-data">デバッグデータ取得エラー: ${error.message}</div>`;
                    addResult('❌ デバッグデータ取得エラー: ' + (error.message || error.toString()), 'error');
                })
                .webAppGetDebugData(targetStage === 'all' ? undefined : targetStage);
        }
        
        function displayDataFlowAnalysis(debugData, targetStage, programName, weekType) {
            const dataflowDisplay = document.getElementById('dataflow-display');
            const stageSummary = document.getElementById('dataflow-stage-summary');
            const summaryContent = document.getElementById('stage-summary-content');
            
            if (!debugData || Object.keys(debugData).length === 0) {
                dataflowDisplay.innerHTML = '<div class="empty-data">デバッグデータが見つかりません</div>';
                return;
            }
            
            // 段階別にデータを整理
            const stageGroups = {};
            Object.entries(debugData).forEach(([key, data]) => {
                const stage = data.stage;
                if (!stageGroups[stage]) {
                    stageGroups[stage] = [];
                }
                stageGroups[stage].push({ key, data });
            });
            
            // 段階順にソート
            const stageOrder = [
                '1-INPUT-SHEET', '2-MARKERS-DETECTED', '3-DATE-RANGES', 
                '4-STRUCTURED-PROGRAMS', '5-FINAL-WEEK-DATA', '6-WEBAPP-INPUT',
                '7-RAW-WEEK-DATA', '8-TRANSFORMED-WEEK-DATA', '9-WEBAPP-FINAL-OUTPUT'
            ];
            
            var html = '<div style="margin-bottom: 20px; padding: 15px; background: #f8f9fa; border-radius: 8px;">' +
                '<h4 style="color: #2d3748; margin: 0 0 5px 0;">' + programName + ' のデータフロー分析</h4>' +
                '<p style="color: #718096; margin: 0; font-size: 0.9rem;">対象: ' + (weekType === 'thisWeek' ? '今週' : '来週') + ' | 段階: ' + (targetStage === 'all' ? '全段階' : targetStage) + ' | データ数: ' + Object.keys(debugData).length + '件</p>' +
                '</div>';
            
            // 段階別サマリーを作成
            var summaryHtml = '';
            var displayedStages = 0;
            
            stageOrder.forEach(function(stage) {
                if (stageGroups[stage] && (targetStage === 'all' || targetStage === stage)) {
                    displayedStages++;
                    var stageData = stageGroups[stage][0]; // 最新のデータを使用
                    var data = stageData.data;
                    
                    summaryHtml += '<div style="margin-bottom: 15px; padding: 10px; background: white; border-radius: 6px; border-left: 4px solid #667eea;">' +
                        '<div style="display: flex; justify-content: space-between; align-items: center;">' +
                        '<strong>' + getStageDisplayName(stage) + '</strong>' +
                        '<span style="color: #718096; font-size: 0.85rem;">' + data.timestamp + '</span>' +
                        '</div>' +
                        '<div style="margin-top: 5px; font-size: 0.9rem; color: #4a5568;">' +
                        'データ型: ' + data.dataType + ' ' + (data.isArray ? '(配列)' : '') + ' | ' +
                        (data.dataType === 'object' ? 'キー数: ' + data.keyCount : '値: ' + (typeof data.data === 'string' ? data.data.substring(0, 50) + '...' : JSON.stringify(data.data).substring(0, 50) + '...')) +
                        '</div>' +
                        '</div>';
                    
                    html += '<div style="margin-bottom: 30px;">' +
                        '<h5 style="color: #2d3748; margin-bottom: 10px; padding-bottom: 5px; border-bottom: 2px solid #e2e8f0;">' +
                        getStageDisplayName(stage) +
                        '</h5>' +
                        '<div style="background: #f7fafc; padding: 10px; border-radius: 6px; margin-bottom: 10px; font-size: 0.9rem;">' +
                        '<strong>コンテキスト:</strong> ' + data.context + '<br>' +
                        '<strong>タイムスタンプ:</strong> ' + data.timestamp + '<br>' +
                        '<strong>データ型:</strong> ' + data.dataType + ' ' + (data.isArray ? '(配列)' : '') + ' | ' +
                        (data.dataType === 'object' ? 'キー数: ' + data.keyCount : '') +
                        '</div>' +
                        '<div style="max-height: 400px; overflow-y: auto;">' +
                        '<pre style="background: #1a202c; color: #e2e8f0; padding: 15px; border-radius: 6px; font-size: 0.8rem; line-height: 1.4; margin: 0;">' + syntaxHighlightJSON(JSON.stringify(data.data, null, 2)) + '</pre>' +
                        '</div>' +
                        '</div>';
                }
            });
            
            if (displayedStages > 0) {
                dataflowDisplay.innerHTML = html;
                summaryContent.innerHTML = summaryHtml;
                stageSummary.style.display = 'block';
            } else {
                dataflowDisplay.innerHTML = '<div class="empty-data">指定された段階のデータが見つかりません</div>';
                stageSummary.style.display = 'none';
            }
        }
        
        function getStageDisplayName(stage) {
            const stageNames = {
                '1-INPUT-SHEET': '1. シート入力データ',
                '2-MARKERS-DETECTED': '2. マーカー検出結果',
                '3-DATE-RANGES': '3. 日付範囲計算結果',
                '4-STRUCTURED-PROGRAMS': '4. 番組構造化結果',
                '5-FINAL-WEEK-DATA': '5. 週データ最終形',
                '6-WEBAPP-INPUT': '6. WebApp入力パラメータ',
                '7-RAW-WEEK-DATA': '7. 生週データ',
                '8-TRANSFORMED-WEEK-DATA': '8. データ変換後',
                '9-WEBAPP-FINAL-OUTPUT': '9. WebApp最終出力'
            };
            return stageNames[stage] || stage;
        }
        
        function syntaxHighlightJSON(json) {
            return json
                .replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;')
                .replace(/("(\\u[a-zA-Z0-9]{4}|\\[^u]|[^\\"])*"(\s*:)?|\b(true|false|null)\b|-?\d+(?:\.\d*)?(?:[eE][+\-]?\d+)?)/g, function (match) {
                    let cls = 'json-number';
                    if (/^"/.test(match)) {
                        if (/:$/.test(match)) {
                            cls = 'json-key';
                        } else {
                            cls = 'json-string';
                        }
                    } else if (/true|false/.test(match)) {
                        cls = 'json-boolean';
                    } else if (/null/.test(match)) {
                        cls = 'json-null';
                    }
                    return '<span style="color: ' + getJSONColor(cls) + '">' + match + '</span>';
                });
        }
        
        function getJSONColor(cls) {
            const colors = {
                'json-key': '#d73a49',
                'json-string': '#032f62', 
                'json-number': '#005cc5',
                'json-boolean': '#e36209',
                'json-null': '#6f42c1'
            };
            return colors[cls] || '#e2e8f0';
        }
        
        function clearDataFlowData() {
            google.script.run
                .withSuccessHandler(() => {
                    document.getElementById('dataflow-display').innerHTML = '<div class="empty-data">デバッグデータをクリアしました</div>';
                    document.getElementById('dataflow-stage-summary').style.display = 'none';
                    addResult('🗑️ デバッグデータをクリアしました', 'info');
                })
                .withFailureHandler((error) => {
                    addResult('❌ データクリアエラー: ' + (error.message || error.toString()), 'error');
                })
                .clearDebugData();
        }
        
        function exportDebugData() {
            const programSelect = document.getElementById('dataflow-program-select');
            const weekSelect = document.getElementById('dataflow-week-select');
            const programName = programSelect.value || 'all';
            const weekType = weekSelect.value || 'all';
            
            google.script.run
                .withSuccessHandler((result) => {
                    if (result && result.success) {
                        // Google Driveに保存されたURLを表示
                        const fileName = `debug_${programName}_${weekType}_${new Date().toISOString().replace(/[:.]/g, '-')}.json`;
                        addResult('💾 デバッグデータをエクスポートしました: ' + fileName, 'success');
                    } else {
                        addResult('❌ エクスポートに失敗しました', 'error');
                    }
                })
                .withFailureHandler((error) => {
                    addResult('❌ エクスポートエラー: ' + (error.message || error.toString()), 'error');
                })
                .webAppGetDebugData();
        }

        // Google Apps Script用のstub（実際の環境では不要）
        if (typeof google === 'undefined') {
            window.google = {
                script: {
                    run: {
                        withSuccessHandler: function(callback) {
                            return {
                                withFailureHandler: function(errorCallback) {
                                    return {
                                        webAppAutoGenerateChoudo: () => {
                                            setTimeout(() => callback({success: true, docxSent: true, url: 'https://docs.google.com/document/d/test'}), 2000);
                                        },
                                        webAppAutoGeneratePrimeTime: () => {
                                            setTimeout(() => callback({success: true, docxSent: true}), 2000);
                                        },
                                        webAppAutoGenerateFlag: () => {
                                            setTimeout(() => callback({success: true, docxSent: false}), 2000);
                                        },
                                        webAppAutoGenerateRoute847: () => {
                                            setTimeout(() => callback({success: true, docxSent: true}), 2000);
                                        },
                                        webAppAutoGenerateGodBless: () => {
                                            setTimeout(() => callback({success: true, docxSent: true}), 2000);
                                        },
                                        webAppTestAllGeneration: () => {
                                            setTimeout(() => callback([
                                                {program: 'ちょうどいいラジオ', success: true, docxSent: true},
                                                {program: 'PRIME TIME', success: true, docxSent: true},
                                                {program: 'FLAG', success: false, error: 'テストエラー', docxSent: false},
                                                {program: 'Route 847', success: true, docxSent: true},
                                                {program: 'God Bless Saturday', success: true, docxSent: true}
                                            ]), 3000);
                                        },
                                        webAppGetConfigInfo: () => {
                                            setTimeout(() => callback({
                                                hasSpreadsheetId: true,
                                                hasCalendarId: true,
                                                hasMusicSpreadsheetId: true,
                                                musicSheetName: 'シート1',
                                                hasEmailAddress: true,
                                                hasDocumentTemplates: true,
                                                templateCount: 5,
                                                hasOutputFolder: true,
                                                hasPortsideCalendar: true
                                            }), 1000);
                                        },
                                        webAppGetProgramData: (programName, weekType) => {
                                            // より詳細なデモデータで実際の構造を再現
                                            const demoData = {
                                                'PRIME TIME': {
                                                    'monday': {
                                                        '日付': ['2024-08-22'],
                                                        '19:41Traffic': ['交通情報データサンプル'],
                                                        '19:43': ['19:43コーナーデータ'],
                                                        '20:51': ['20:51コーナーデータ'],
                                                        '営業コーナー': ['営業案件サンプル'],
                                                        '楽曲': ['♪アーティスト1 - 楽曲1', '♪アーティスト2 - 楽曲2'],
                                                        'ゲスト': ['ゲスト情報サンプル'],
                                                        '時間指定なしパブ': ['パブリシティ情報'],
                                                        'ラジショピ': ['ラジオショッピング'],
                                                        '先行予約・限定予約': ['予約情報サンプル']
                                                    },
                                                    'tuesday': {
                                                        '日付': ['2024-08-23'],
                                                        '19:41Traffic': ['ー'],
                                                        '19:43': ['火曜日のコーナー'],
                                                        '20:51': ['ー'],
                                                        '営業コーナー': ['火曜営業案件'],
                                                        '楽曲': ['♪火曜アーティスト - 火曜楽曲'],
                                                        'ゲスト': ['ー'],
                                                        '時間指定なしパブ': ['ー'],
                                                        'ラジショピ': ['ー'],
                                                        '先行予約・限定予約': ['ー']
                                                    }
                                                },
                                                'ちょうどいいラジオ': {
                                                    'monday': {
                                                        '日付': ['2024-08-22'],
                                                        'パーソナリティ': ['サンプル太郎'],
                                                        'ゲスト': ['ゲスト花子'],
                                                        '内容': ['番組内容サンプル'],
                                                        '楽曲': ['♪楽曲データ1', '♪楽曲データ2'],
                                                        '放送後': ['放送後情報']
                                                    }
                                                }
                                            };

                                            setTimeout(() => callback({
                                                success: true,
                                                programName: programName,
                                                weekType: weekType,
                                                sheetName: (weekType === 'thisWeek' ? '今週' : '翌週') + 'のシート (25.8.18-8.24)',
                                                timestamp: new Date().toISOString(),
                                                data: demoData[programName] || {
                                                    'デモデータ': {
                                                        '注意': ['実際のデータではありません'],
                                                        '利用可能番組': Object.keys(demoData)
                                                    }
                                                }
                                            }), 2000);
                                        }
                                    };
                                }
                            };
                        }
                    }
                }
            };
        }

        // 番組一覧表の読み込み
        function loadProgramTable() {
            const tableDisplay = document.getElementById('table-display');
            const tableFilters = document.querySelector('.table-filters');
            
            // ローディング表示
            tableDisplay.innerHTML = '<div class="loading-data">番組データを読み込み中...</div>';
            
            google.script.run
                .withSuccessHandler(function(result) {
                    if (result.success) {
                        displayProgramTable(result.data);
                        tableFilters.style.display = 'block';
                    } else {
                        tableDisplay.innerHTML = `<div class="error-data">エラー: ${result.error}</div>`;
                    }
                })
                .withFailureHandler(function(error) {
                    tableDisplay.innerHTML = `<div class="error-data">読み込みエラー: ${error.message}</div>`;
                })
                .webAppGetSingleProgramTable(selectedProgram);
        }

        // 番組別転置テーブルの読み込み（メイン関数）
        function loadSingleProgramTable() {
            loadTransposedProgramTable(); // 転置テーブルを直接呼び出し
        }

        // 転置テーブル形式の番組詳細表を読み込み
        function loadTransposedProgramTable() {
            const programSelect = document.getElementById('program-select-table');
            const weekSelect = document.getElementById('week-select-table');
            const selectedProgram = programSelect.value;
            const selectedWeek = weekSelect.value;
            const tableDisplay = document.getElementById('table-display');
            
            // 番組選択の厳密な検証
            if (!selectedProgram || selectedProgram.trim() === '' || selectedProgram === 'undefined') {
                tableDisplay.innerHTML = '<div class="error-data">番組を選択してください</div>';
                displayDebugLog([`[ERROR] 不正な番組選択: "${selectedProgram}"`]);
                return;
            }
            
            // デバッグ情報を表示
            displayDebugLog([`[INFO] 番組選択: "${selectedProgram}", 週: "${selectedWeek}"`]);
            
            // ローディング表示  
            const weekLabelMap = {
                'thisWeek': '今週',
                'nextWeek': '来週', 
                'nextWeek2': '来週の次',
                'nextWeek3': '来週の次の次'
            };
            const weekLabel = weekLabelMap[selectedWeek] || '今週';
            tableDisplay.innerHTML = `<div class="loading-data">${weekLabel}の転置テーブルを生成中...</div>`;
            
            google.script.run
                .withSuccessHandler(function(result) {
                    if (result.success) {
                        displayTransposedTable(result);
                    } else {
                        tableDisplay.innerHTML = `<div class="error-data">エラー: ${result.error}</div>`;
                        // エラーでもデバッグログを表示
                        if (result.debugLogs) {
                            displayDebugLog(result.debugLogs);
                        }
                    }
                })
                .withFailureHandler(function(error) {
                    tableDisplay.innerHTML = '<div class="error-data">読み込みエラー: ' + error.message + '</div>';
                    // 通信エラーの場合のログ
                    displayDebugLog(['[ERROR] 通信エラー: ' + error.message, '[DEBUG] スタックトレース: ' + (error.stack || 'なし')]);
                })
                .generateTransposedProgramTable(selectedProgram, selectedWeek);
        }

        // 転置テーブルの表示（日付が列、項目が行）
        function displayTransposedTable(result) {
            const tableDisplay = document.getElementById('table-display');
            
            // デバッグログを表示
            if (result.debugLogs) {
                displayDebugLog(result.debugLogs);
            }
            
            if (!result.data || !result.data.headers || !result.data.rows) {
                tableDisplay.innerHTML = `<div class="empty-data">転置テーブルデータが取得できませんでした</div>`;
                return;
            }

            const data = result.data;
            
            // 番組情報ヘッダー
            let html = `
                <div style="margin-bottom: 20px; padding: 15px; background: #f8f9fa; border-radius: 8px;">
                    <h4 style="color: #2d3748; margin: 0 0 5px 0;">${data.programName}</h4>
                    <p style="color: #718096; margin: 0; font-size: 0.9rem;">項目数: ${data.rows.length}項目 | 期間: ${data.headers.length - 1}日間</p>
                </div>
                <div style="overflow-x: auto;">
                    <table class="data-table transposed-table" id="transposed-detail-table" style="min-width: 800px;">
                        <thead>
                            <tr>
            `;

            // ヘッダー行（項目 + 日付列）
            data.headers.forEach((header, index) => {
                const isFirstColumn = index === 0;
                const style = isFirstColumn 
                    ? 'background: #2d3748; color: white; font-weight: bold; min-width: 150px; position: sticky; left: 0; z-index: 1;' 
                    : 'background: #4a5568; color: white; min-width: 120px; text-align: center;';
                html += `<th style="${style}">${header}</th>`;
            });

            html += `
                            </tr>
                        </thead>
                        <tbody>
            `;

            // データ行（各項目）
            data.rows.forEach((row, rowIndex) => {
                html += '<tr>';
                
                row.forEach((cell, cellIndex) => {
                    const isFirstColumn = cellIndex === 0;
                    const isEmptyData = cell === 'ー' || cell === '' || cell == null;
                    
                    let cellStyle = '';
                    let cellClass = '';
                    
                    if (isFirstColumn) {
                        // 項目名列（固定）
                        cellStyle = 'background: #f7fafc; font-weight: bold; position: sticky; left: 0; z-index: 1; border-right: 2px solid #e2e8f0;';
                        cellClass = 'item-name-cell';
                    } else {
                        // データ列
                        cellStyle = isEmptyData 
                            ? 'text-align: center; color: #a0aec0; font-style: italic;'
                            : 'word-wrap: break-word; font-size: 0.85rem; line-height: 1.3;';
                        cellClass = isEmptyData ? 'empty-cell' : 'data-cell';
                    }
                    
                    const maxWidth = isFirstColumn ? '150px' : '120px';
                    const displayText = isEmptyData && !isFirstColumn ? 'ー' : cell;
                    
                    html += `<td class="${cellClass}" style="${cellStyle} max-width: ${maxWidth}; padding: 8px;">${displayText}</td>`;
                });
                
                html += '</tr>';
            });

            html += '</tbody></table></div>';
            
            // 補助情報
            html += `
                <div style="margin-top: 15px; padding: 10px; background: #e6fffa; border-left: 4px solid #38b2ac; border-radius: 4px; font-size: 0.85rem;">
                    <strong>転置テーブル表示:</strong> 
                    項目を行として、日付を列として表示しています。横スクロールで全ての日付が確認できます。
                </div>
                <div style="margin-top: 10px; padding: 10px; background: #f0f0f0; border-radius: 5px; font-size: 0.8rem; color: #666;">
                    <strong>デバッグ情報:</strong> 
                    ${data.programName} - ${data.rows.length}項目 × ${data.headers.length - 1}日のデータを転置表示
                </div>
            `;
            
            tableDisplay.innerHTML = html;
        }

        // 通常テーブル表示機能（転置テーブル専用のため削除済み）
        // displaySingleProgramTable 関数は転置テーブル専用インターフェースのため削除

        // 番組一覧表の表示
        function displayProgramTable(programs) {
            const tableDisplay = document.getElementById('table-display');
            
            if (!programs || programs.length === 0) {
                tableDisplay.innerHTML = '<div class="empty-data">番組データがありません</div>';
                return;
            }

            let html = `
                <table class="data-table program-table" id="program-table">
                    <thead>
                        <tr>
                            <th onclick="sortTable(0)">番組名 ↕</th>
                            <th onclick="sortTable(1)">ID</th>
                            <th onclick="sortTable(2)">エピソード数 ↕</th>
                            <th onclick="sortTable(3)">録音数 ↕</th>
                            <th onclick="sortTable(4)">最新エピソード ↕</th>
                            <th onclick="sortTable(5)">総楽曲数 ↕</th>
                            <th onclick="sortTable(6)">総告知数 ↕</th>
                            <th>詳細</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            programs.forEach((program, index) => {
                html += `
                    <tr>
                        <td><strong>${program.name}</strong></td>
                        <td><code>${program.id}</code></td>
                        <td>${program.episodeCount}</td>
                        <td>${program.recordingCount}</td>
                        <td>${program.latestEpisode}</td>
                        <td>${program.totalSongs}</td>
                        <td>${program.totalAnnouncements}</td>
                        <td>
                            <button class="btn btn-sm" onclick="toggleEpisodeDetails(${index})" 
                                    id="detail-btn-${index}">
                                表示
                            </button>
                        </td>
                    </tr>
                    <tr id="episode-details-${index}" style="display: none;">
                        <td colspan="8">
                            <div class="episode-details">
                                ${generateEpisodeDetailsHTML(program.episodes)}
                            </div>
                        </td>
                    </tr>
                `;
            });

            html += '</tbody></table>';
            tableDisplay.innerHTML = html;
            
            // グローバル変数に保存（フィルタリング用）
            window.currentPrograms = programs;
        }

        // エピソード詳細HTMLの生成
        function generateEpisodeDetailsHTML(episodes) {
            if (!episodes || episodes.length === 0) {
                return '<p>エピソードがありません</p>';
            }

            let html = `
                <table class="data-table episode-table">
                    <thead>
                        <tr>
                            <th>日付</th>
                            <th>曜日</th>
                            <th>楽曲数</th>
                            <th>告知数</th>
                            <th>予約数</th>
                            <th>パブ枠数</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            episodes.forEach(episode => {
                html += `
                    <tr>
                        <td>${episode.date}</td>
                        <td>${episode.weekday}</td>
                        <td>${episode.songCount}</td>
                        <td>${episode.announcementCount}</td>
                        <td>${episode.reservationCount}</td>
                        <td>${episode.publicitySlotCount}</td>
                    </tr>
                `;
            });

            html += '</tbody></table>';
            return html;
        }

        // エピソード詳細の表示切り替え
        function toggleEpisodeDetails(index) {
            var detailsRow = document.getElementById('episode-details-' + index);
            var button = document.getElementById('detail-btn-' + index);
            
            if (detailsRow.style.display === 'none') {
                detailsRow.style.display = '';
                button.textContent = '非表示';
            } else {
                detailsRow.style.display = 'none';
                button.textContent = '表示';
            }
        }

        // 番組表のフィルタリング
        function filterProgramTable() {
            const filter = document.getElementById('program-filter').value.toLowerCase();
            const table = document.getElementById('program-table');
            const rows = table.getElementsByTagName('tr');

            for (let i = 1; i < rows.length; i += 2) { // 奇数行のみ（番組行）
                const programName = rows[i].getElementsByTagName('td')[0].textContent.toLowerCase();
                if (programName.indexOf(filter) > -1) {
                    rows[i].style.display = '';
                    if (i + 1 < rows.length) rows[i + 1].style.display = ''; // 詳細行も表示
                } else {
                    rows[i].style.display = 'none';
                    if (i + 1 < rows.length) rows[i + 1].style.display = 'none'; // 詳細行も非表示
                }
            }
        }

        // 表のソート機能
        function sortTable(columnIndex) {
            const table = document.getElementById('program-table');
            const tbody = table.getElementsByTagName('tbody')[0];
            const rows = Array.from(tbody.getElementsByTagName('tr'));
            
            // 番組行のみを取得（偶数インデックス）
            const programRows = rows.filter((row, index) => index % 2 === 0);
            
            programRows.sort((a, b) => {
                const aValue = a.getElementsByTagName('td')[columnIndex].textContent;
                const bValue = b.getElementsByTagName('td')[columnIndex].textContent;
                
                // 数値の場合は数値として比較
                if (!isNaN(aValue) && !isNaN(bValue)) {
                    return parseInt(bValue) - parseInt(aValue);
                }
                
                // 文字列として比較
                return aValue.localeCompare(bValue);
            });

            // 表を再構築
            tbody.innerHTML = '';
            programRows.forEach((row, index) => {
                tbody.appendChild(row);
                // 対応する詳細行も追加
                const detailsRow = rows[rows.indexOf(row) + 1];
                if (detailsRow) {
                    tbody.appendChild(detailsRow);
                }
            });
        }
        
        // デバッグログ関連の機能
        function showDebugLog() {
            document.getElementById('debug-log-section').style.display = 'block';
            document.getElementById('debug-controls').style.display = 'none';
        }
        
        function hideDebugLog() {
            document.getElementById('debug-log-section').style.display = 'none';
            document.getElementById('debug-controls').style.display = 'block';
        }
        
        function displayDebugLog(logs) {
            var logContent = document.getElementById('debug-log-content');
            var debugControls = document.getElementById('debug-controls');
            
            if (logs && logs.length > 0) {
                // ログをフォーマット
                var formattedLogs = [];
                for (var i = 0; i < logs.length; i++) {
                    var timestamp = new Date().toLocaleTimeString();
                    formattedLogs.push('[' + timestamp + '] ' + logs[i]);
                }
                var formattedLog = formattedLogs.join('\n');
                
                logContent.textContent = formattedLog;
                debugControls.style.display = 'block';
                
                // エラーが含まれる場合は自動的に表示
                if (logs.some(log => log.includes('[ERROR]') || log.includes('エラー'))) {
                    showDebugLog();
                }
            } else {
                logContent.textContent = 'デバッグログがありません';
                debugControls.style.display = 'none';
            }
        }
        
        function clearDebugLog() {
            document.getElementById('debug-log-content').textContent = '';
            document.getElementById('debug-log-section').style.display = 'none';
            document.getElementById('debug-controls').style.display = 'none';
        }
    </script>
</body>
</html>