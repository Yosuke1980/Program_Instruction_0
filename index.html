<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ラジオ番組データ表示</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            line-height: 1.6;
            color: #333;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1000px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2rem;
            margin-bottom: 10px;
            font-weight: 700;
        }

        .header p {
            opacity: 0.9;
            font-size: 1.1rem;
        }

        .content {
            padding: 40px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            font-weight: 600;
            margin-bottom: 8px;
            color: #2d3748;
        }

        .form-group select {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-size: 1rem;
            background: white;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .form-group select:hover {
            border-color: #cbd5e0;
        }

        .form-group select:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .button {
            width: 100%;
            padding: 14px 24px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-top: 10px;
        }

        .button:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(102, 126, 234, 0.3);
        }

        .button:active {
            transform: translateY(0);
        }

        .button:disabled {
            background: #cbd5e0;
            cursor: not-allowed;
            transform: none;
        }

        .json-display {
            margin-top: 30px;
            padding: 20px;
            background: #f7fafc;
            border-radius: 8px;
            border: 2px solid #e2e8f0;
        }

        .json-display h3 {
            color: #2d3748;
            margin-bottom: 15px;
            font-size: 1.2rem;
        }

        .json-code {
            background: #2d3748;
            color: #68d391;
            padding: 20px;
            border-radius: 8px;
            overflow-x: auto;
            font-family: 'Monaco', 'Menlo', 'Courier New', monospace;
            font-size: 0.9rem;
            line-height: 1.6;
            white-space: pre-wrap;
            word-wrap: break-word;
            max-height: 600px;
            overflow-y: auto;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #718096;
        }

        .loading-spinner {
            border: 4px solid #e2e8f0;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .error {
            background: #fff5f5;
            border: 2px solid #fc8181;
            color: #c53030;
            padding: 16px;
            border-radius: 8px;
            margin-top: 20px;
        }

        .success-info {
            background: #f0fff4;
            border: 2px solid #68d391;
            color: #22543d;
            padding: 16px;
            border-radius: 8px;
            margin-bottom: 15px;
        }

        .info-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 10px;
            margin-top: 10px;
        }

        .info-item {
            display: flex;
            justify-content: space-between;
            padding: 8px;
            background: white;
            border-radius: 4px;
        }

        .info-label {
            font-weight: 600;
            color: #2d3748;
        }

        .info-value {
            color: #4a5568;
        }

        .hidden {
            display: none;
        }

        /* 表形式表示のスタイル */
        .table-display {
            margin-top: 30px;
            padding: 20px;
            background: #f7fafc;
            border-radius: 8px;
            border: 2px solid #e2e8f0;
        }

        .table-display h3 {
            color: #2d3748;
            margin-bottom: 15px;
            font-size: 1.2rem;
        }

        .view-toggle {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }

        .view-toggle button {
            flex: 1;
            padding: 10px;
            background: white;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .view-toggle button.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-color: #667eea;
        }

        .view-toggle button:hover {
            border-color: #667eea;
        }

        .program-table-container {
            overflow-x: auto;
            background: white;
            border-radius: 8px;
            padding: 20px;
        }

        .program-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.9rem;
        }

        .program-table th,
        .program-table td {
            padding: 12px;
            text-align: left;
            border: 1px solid #e2e8f0;
            vertical-align: top;
        }

        .program-table th {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            font-weight: 600;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .program-table tr:nth-child(even) {
            background: #f7fafc;
        }

        .program-table tr:hover {
            background: #edf2f7;
        }

        .category-cell {
            font-weight: 600;
            background: #edf2f7;
            color: #2d3748;
            min-width: 150px;
        }

        .day-cell {
            min-width: 200px;
        }

        .music-item {
            margin-bottom: 10px;
            padding: 8px;
            background: #f0fff4;
            border-left: 3px solid #68d391;
            border-radius: 4px;
        }

        .music-title {
            font-weight: 600;
            color: #2d3748;
            margin-bottom: 4px;
        }

        .music-url {
            font-size: 0.85rem;
            color: #667eea;
            word-break: break-all;
        }

        .music-metadata {
            font-size: 0.85rem;
            color: #718096;
            margin-top: 4px;
            padding: 4px 8px;
            background: #fff5e6;
            border-radius: 4px;
            border-left: 2px solid #f6ad55;
        }

        .item-list {
            list-style: none;
            padding: 0;
        }

        .item-list li {
            padding: 4px 0;
            border-bottom: 1px dotted #e2e8f0;
        }

        .item-list li:last-child {
            border-bottom: none;
        }

        /* タブナビゲーション */
        .tab-navigation {
            display: flex;
            gap: 0;
            margin-bottom: 30px;
            border-bottom: 2px solid #e2e8f0;
        }

        .tab-btn {
            flex: 1;
            padding: 14px 20px;
            background: transparent;
            border: none;
            border-bottom: 3px solid transparent;
            font-size: 1rem;
            font-weight: 600;
            color: #718096;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .tab-btn:hover {
            color: #667eea;
            background: #f7fafc;
        }

        .tab-btn.active {
            color: #667eea;
            border-bottom-color: #667eea;
            background: #f7fafc;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        /* メール設定管理 */
        .email-settings-container {
            margin-top: 20px;
        }

        .program-settings-list {
            display: grid;
            gap: 20px;
        }

        .program-settings-card {
            background: #f7fafc;
            border: 2px solid #e2e8f0;
            border-radius: 12px;
            padding: 20px;
            transition: all 0.3s ease;
        }

        .program-settings-card:hover {
            border-color: #667eea;
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.1);
        }

        .program-settings-card.enabled {
            border-color: #68d391;
            background: #f0fff4;
        }

        .program-settings-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid #e2e8f0;
        }

        .program-settings-header h3 {
            margin: 0;
            color: #2d3748;
            font-size: 1.2rem;
        }

        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 60px;
            height: 30px;
        }

        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #cbd5e0;
            transition: 0.3s;
            border-radius: 30px;
        }

        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 22px;
            width: 22px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: 0.3s;
            border-radius: 50%;
        }

        input:checked + .toggle-slider {
            background-color: #68d391;
        }

        input:checked + .toggle-slider:before {
            transform: translateX(30px);
        }

        .settings-form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 15px;
        }

        .settings-form-row.full-width {
            grid-template-columns: 1fr;
        }

        .settings-label {
            display: block;
            font-weight: 600;
            margin-bottom: 6px;
            color: #2d3748;
            font-size: 0.9rem;
        }

        .settings-input,
        .settings-select {
            width: 100%;
            padding: 10px 12px;
            border: 2px solid #e2e8f0;
            border-radius: 6px;
            font-size: 0.95rem;
            transition: all 0.3s ease;
        }

        .settings-input:focus,
        .settings-select:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .settings-textarea {
            width: 100%;
            padding: 10px 12px;
            border: 2px solid #e2e8f0;
            border-radius: 6px;
            font-size: 0.95rem;
            resize: vertical;
            min-height: 60px;
            font-family: inherit;
        }

        .settings-textarea:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .settings-buttons {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }

        .btn-save,
        .btn-test {
            flex: 1;
            padding: 10px 16px;
            border: none;
            border-radius: 6px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn-save {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-save:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
        }

        .btn-test {
            background: white;
            color: #667eea;
            border: 2px solid #667eea;
        }

        .btn-test:hover {
            background: #f7fafc;
        }

        .btn-test:disabled,
        .btn-save:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .trigger-setup-section {
            margin-top: 30px;
            padding: 20px;
            background: #fff5e6;
            border: 2px solid #f6ad55;
            border-radius: 12px;
        }

        .trigger-setup-section h3 {
            margin: 0 0 10px 0;
            color: #2d3748;
        }

        .trigger-setup-section p {
            margin: 0 0 15px 0;
            color: #4a5568;
            font-size: 0.95rem;
        }

        .btn-trigger-setup {
            width: 100%;
            padding: 12px 20px;
            background: #f6ad55;
            color: white;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn-trigger-setup:hover {
            background: #ed8936;
            transform: translateY(-2px);
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ラジオ番組データ表示</h1>
            <p>番組と週を選択してJSONデータを表示</p>
        </div>

        <div class="content">
            <!-- タブ切り替え -->
            <div class="tab-navigation">
                <button class="tab-btn active" onclick="switchTab('data')">番組データ表示</button>
                <button class="tab-btn" onclick="switchTab('email')">メール設定管理</button>
            </div>

            <!-- 番組データ表示タブ -->
            <div id="dataTab" class="tab-content active">
            <div class="form-group">
                <label for="programSelect">番組を選択</label>
                <select id="programSelect">
                    <option value="">番組を選択してください</option>
                    <option value="ちょうどいいラジオ">ちょうどいいラジオ</option>
                    <option value="PRIME TIME">PRIME TIME</option>
                    <option value="FLAG">FLAG</option>
                    <option value="God Bless Saturday">God Bless Saturday</option>
                    <option value="Route 847">Route 847</option>
                </select>
            </div>

            <div class="form-group">
                <label for="weekSelect">週を選択</label>
                <select id="weekSelect">
                    <option value="thisWeek">今週</option>
                    <option value="nextWeek">1週先</option>
                    <option value="nextWeek2">2週先</option>
                    <option value="nextWeek3">3週先</option>
                    <option value="nextWeek4">4週先</option>
                </select>
            </div>

            <button class="button" id="displayBtn" onclick="displayJSON()">JSONを表示</button>

            <div id="loadingArea" class="loading hidden">
                <div class="loading-spinner"></div>
                <p>データを読み込み中...</p>
            </div>

            <div id="errorArea" class="error hidden"></div>

            <div id="successInfo" class="success-info hidden"></div>

            <div id="dataDisplay" class="hidden">
                <div class="view-toggle">
                    <button id="tableViewBtn" class="active" onclick="switchView('table')">表形式</button>
                    <button id="jsonViewBtn" onclick="switchView('json')">JSON形式</button>
                    <button id="pdfDownloadBtn" onclick="downloadPDF()" style="background: linear-gradient(135deg, #48bb78 0%, #38a169 100%);">PDFダウンロード</button>
                </div>

                <div id="tableDisplay" class="table-display">
                    <h3>番組データ (表形式)</h3>
                    <div id="tableContainer" class="program-table-container"></div>
                </div>

                <div id="jsonDisplay" class="json-display hidden">
                    <h3>番組データ (JSON)</h3>
                    <div id="jsonCode" class="json-code"></div>
                </div>
            </div>
            </div>

            <!-- メール設定管理タブ -->
            <div id="emailTab" class="tab-content">
                <div class="email-settings-container">
                    <div id="emailSettingsList" class="program-settings-list">
                        <!-- 番組ごとの設定カードが動的に生成される -->
                    </div>

                    <div class="trigger-setup-section">
                        <h3>自動送信トリガー設定</h3>
                        <p>有効な番組のメール送信スケジュールを自動的にトリガー設定します。設定を変更した後は必ずこのボタンを押してください。</p>
                        <button class="btn-trigger-setup" onclick="setupTriggers()">トリガーを再設定</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let currentData = null;
        let allEmailSettings = {};

        // =============================================================================
        // タブ切り替え機能
        // =============================================================================

        function switchTab(tabName) {
            // タブボタンの切り替え
            const tabButtons = document.querySelectorAll('.tab-btn');
            tabButtons.forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');

            // コンテンツの切り替え
            const dataTab = document.getElementById('dataTab');
            const emailTab = document.getElementById('emailTab');

            if (tabName === 'data') {
                dataTab.classList.add('active');
                emailTab.classList.remove('active');
            } else if (tabName === 'email') {
                dataTab.classList.remove('active');
                emailTab.classList.add('active');
                // メール設定タブを開いたときに設定をロード
                loadEmailSettings();
            }
        }

        // =============================================================================
        // メール設定管理機能
        // =============================================================================

        function loadEmailSettings() {
            console.log('メール設定をロード中...');

            google.script.run
                .withSuccessHandler(function(result) {
                    if (result.success) {
                        allEmailSettings = result.settings;
                        renderEmailSettings();
                    } else {
                        alert('設定の読み込みに失敗しました: ' + result.error);
                    }
                })
                .withFailureHandler(function(error) {
                    alert('通信エラー: ' + error.message);
                })
                .getAllEmailSettings();
        }

        function renderEmailSettings() {
            const container = document.getElementById('emailSettingsList');
            container.innerHTML = '';

            const programs = [
                'ちょうどいいラジオ',
                'PRIME TIME',
                'FLAG',
                'God Bless Saturday',
                'Route 847'
            ];

            programs.forEach(programName => {
                const settings = allEmailSettings[programName] || {};
                const card = createSettingsCard(programName, settings);
                container.appendChild(card);
            });
        }

        function createSettingsCard(programName, settings) {
            const card = document.createElement('div');
            card.className = 'program-settings-card' + (settings.enabled ? ' enabled' : '');
            card.id = 'card-' + programName.replace(/\s+/g, '_');

            const dayOptions = [
                { value: 0, label: '日曜日' },
                { value: 1, label: '月曜日' },
                { value: 2, label: '火曜日' },
                { value: 3, label: '水曜日' },
                { value: 4, label: '木曜日' },
                { value: 5, label: '金曜日' },
                { value: 6, label: '土曜日' }
            ];

            const weekOptions = [
                { value: 'thisWeek', label: '今週' },
                { value: 'nextWeek', label: '1週先' },
                { value: 'nextWeek2', label: '2週先' },
                { value: 'nextWeek3', label: '3週先' },
                { value: 'nextWeek4', label: '4週先' }
            ];

            const hourOptions = Array.from({ length: 24 }, (_, i) => i);

            card.innerHTML = `
                <div class="program-settings-header">
                    <h3>${escapeHtml(programName)}</h3>
                    <label class="toggle-switch">
                        <input type="checkbox" ${settings.enabled ? 'checked' : ''}
                               onchange="toggleEnabled('${programName}', this.checked)">
                        <span class="toggle-slider"></span>
                    </label>
                </div>

                <div class="settings-form-row full-width">
                    <div>
                        <label class="settings-label">送信先メールアドレス (カンマ区切り可)</label>
                        <textarea class="settings-textarea"
                                  id="recipients-${programName.replace(/\s+/g, '_')}"
                                  placeholder="email@example.com">${escapeHtml(settings.recipients || '')}</textarea>
                    </div>
                </div>

                <div class="settings-form-row">
                    <div>
                        <label class="settings-label">送信曜日</label>
                        <select class="settings-select" id="day-${programName.replace(/\s+/g, '_')}">
                            ${dayOptions.map(opt =>
                                `<option value="${opt.value}" ${settings.day === opt.value ? 'selected' : ''}>${opt.label}</option>`
                            ).join('')}
                        </select>
                    </div>
                    <div>
                        <label class="settings-label">送信時刻</label>
                        <select class="settings-select" id="hour-${programName.replace(/\s+/g, '_')}">
                            ${hourOptions.map(hour =>
                                `<option value="${hour}" ${settings.hour === hour ? 'selected' : ''}>${hour}時</option>`
                            ).join('')}
                        </select>
                    </div>
                </div>

                <div class="settings-form-row">
                    <div>
                        <label class="settings-label">送信対象週</label>
                        <select class="settings-select" id="weekType-${programName.replace(/\s+/g, '_')}">
                            ${weekOptions.map(opt =>
                                `<option value="${opt.value}" ${settings.weekType === opt.value ? 'selected' : ''}>${opt.label}</option>`
                            ).join('')}
                        </select>
                    </div>
                </div>

                <div class="settings-buttons">
                    <button class="btn-save" onclick="saveSettings('${programName}')">設定を保存</button>
                    <button class="btn-test" onclick="sendTest('${programName}')">テスト送信</button>
                </div>
            `;

            return card;
        }

        function toggleEnabled(programName, enabled) {
            const card = document.getElementById('card-' + programName.replace(/\s+/g, '_'));
            if (enabled) {
                card.classList.add('enabled');
            } else {
                card.classList.remove('enabled');
            }
        }

        function saveSettings(programName) {
            const id = programName.replace(/\s+/g, '_');
            const settings = {
                enabled: document.querySelector(`#card-${id} input[type="checkbox"]`).checked,
                recipients: document.getElementById('recipients-' + id).value.trim(),
                day: parseInt(document.getElementById('day-' + id).value),
                hour: parseInt(document.getElementById('hour-' + id).value),
                weekType: document.getElementById('weekType-' + id).value
            };

            console.log('設定保存:', programName, settings);

            google.script.run
                .withSuccessHandler(function(result) {
                    if (result.success) {
                        alert('設定を保存しました: ' + programName);
                        allEmailSettings[programName] = settings;
                    } else {
                        alert('保存に失敗しました: ' + result.message);
                    }
                })
                .withFailureHandler(function(error) {
                    alert('通信エラー: ' + error.message);
                })
                .saveEmailSettings(programName, settings);
        }

        function sendTest(programName) {
            const id = programName.replace(/\s+/g, '_');
            const weekType = document.getElementById('weekType-' + id).value;

            if (!confirm(`${programName} のテストメールを送信しますか？\n対象週: ${getWeekLabel(weekType)}`)) {
                return;
            }

            console.log('テストメール送信:', programName, weekType);

            google.script.run
                .withSuccessHandler(function(result) {
                    if (result.success) {
                        alert('テストメールを送信しました！\n' + result.message);
                    } else {
                        alert('送信に失敗しました: ' + result.message);
                    }
                })
                .withFailureHandler(function(error) {
                    alert('通信エラー: ' + error.message);
                })
                .sendTestEmail(programName, weekType);
        }

        function setupTriggers() {
            if (!confirm('メール送信トリガーを再設定しますか？\n既存のトリガーは削除され、有効な番組のみ新しいトリガーが作成されます。')) {
                return;
            }

            console.log('トリガー再設定開始');

            google.script.run
                .withSuccessHandler(function(result) {
                    if (result.success) {
                        alert('トリガー設定完了！\n' + result.message);
                    } else {
                        alert('トリガー設定に失敗しました: ' + result.message);
                    }
                })
                .withFailureHandler(function(error) {
                    alert('通信エラー: ' + error.message);
                })
                .setupEmailTriggers();
        }

        // =============================================================================
        // 番組データ表示機能（既存）
        // =============================================================================

        function displayJSON() {
            const programSelect = document.getElementById('programSelect');
            const weekSelect = document.getElementById('weekSelect');
            const loadingArea = document.getElementById('loadingArea');
            const errorArea = document.getElementById('errorArea');
            const dataDisplay = document.getElementById('dataDisplay');
            const displayBtn = document.getElementById('displayBtn');
            const successInfo = document.getElementById('successInfo');

            const programName = programSelect.value;
            const weekType = weekSelect.value;

            // バリデーション
            if (!programName) {
                errorArea.textContent = '番組を選択してください';
                errorArea.classList.remove('hidden');
                return;
            }

            // UI更新
            loadingArea.classList.remove('hidden');
            errorArea.classList.add('hidden');
            dataDisplay.classList.add('hidden');
            displayBtn.disabled = true;

            // Google Apps Scriptの関数を呼び出し
            google.script.run
                .withSuccessHandler(function(result) {
                    loadingArea.classList.add('hidden');
                    displayBtn.disabled = false;

                    if (result.success) {
                        // 表形式とJSONの両方を生成（先にソート）
                        const sortedResult = sortResultByDays(result);

                        // ソート済みデータを保存
                        currentData = sortedResult;

                        // 成功情報を表示
                        successInfo.innerHTML = `
                            <div style="margin-bottom: 10px; font-size: 1.1rem; font-weight: 700;">
                                データ取得成功
                            </div>
                            <div class="info-grid">
                                <div class="info-item">
                                    <span class="info-label">番組:</span>
                                    <span class="info-value">${sortedResult.programName}</span>
                                </div>
                                <div class="info-item">
                                    <span class="info-label">週:</span>
                                    <span class="info-value">${getWeekLabel(sortedResult.weekType)}</span>
                                </div>
                                <div class="info-item">
                                    <span class="info-label">シート:</span>
                                    <span class="info-value">${sortedResult.sheetName}</span>
                                </div>
                                <div class="info-item">
                                    <span class="info-label">取得時刻:</span>
                                    <span class="info-value">${formatTimestamp(sortedResult.timestamp)}</span>
                                </div>
                            </div>
                        `;
                        successInfo.classList.remove('hidden');

                        generateTableView(sortedResult);
                        document.getElementById('jsonCode').textContent = JSON.stringify(sortedResult, null, 2);

                        // 表示エリアを表示
                        dataDisplay.classList.remove('hidden');

                        // デフォルトで表形式を表示
                        switchView('table');
                    } else {
                        errorArea.textContent = 'エラー: ' + result.error;
                        errorArea.classList.remove('hidden');
                    }
                })
                .withFailureHandler(function(error) {
                    loadingArea.classList.add('hidden');
                    displayBtn.disabled = false;
                    errorArea.textContent = '通信エラー: ' + error.message;
                    errorArea.classList.remove('hidden');
                })
                .getProgramData(programName, weekType);
        }

        function switchView(viewType) {
            const tableDisplay = document.getElementById('tableDisplay');
            const jsonDisplay = document.getElementById('jsonDisplay');
            const tableViewBtn = document.getElementById('tableViewBtn');
            const jsonViewBtn = document.getElementById('jsonViewBtn');

            if (viewType === 'table') {
                tableDisplay.classList.remove('hidden');
                jsonDisplay.classList.add('hidden');
                tableViewBtn.classList.add('active');
                jsonViewBtn.classList.remove('active');
            } else {
                tableDisplay.classList.add('hidden');
                jsonDisplay.classList.remove('hidden');
                tableViewBtn.classList.remove('active');
                jsonViewBtn.classList.add('active');
            }
        }

        function generateTableView(result) {
            const tableContainer = document.getElementById('tableContainer');

            if (!result.data || !result.data.weekData) {
                tableContainer.innerHTML = '<p>データがありません</p>';
                return;
            }

            const weekData = result.data.weekData;
            const dayOrder = ['monday', 'tuesday', 'wednesday', 'thursday', 'friday', 'saturday', 'sunday'];

            // 曜日データのみを抽出
            const days = dayOrder.filter(day => weekData[day]);

            if (days.length === 0) {
                tableContainer.innerHTML = '<p>曜日データがありません</p>';
                return;
            }

            // 番組別の項目順序定義
            const programKeyOrder = {
                'ちょうどいいラジオ': [
                    '7:28パブ告知',
                    '時間指定なし告知',
                    'YOKOHAMA PORTSIDE INFORMATION',
                    '楽曲',
                    '先行予約',
                    'ゲスト',
                    'ラジオショッピング',
                    'はぴねすくらぶ',
                    'ヨコアリくん',
                    'その他',
                    '放送後',
                    'ちょうどいい暮らし収録予定',
                    'ここが知りたい不動産収録予定',
                    'ちょうどいい歯ッピー収録予定',
                    'ちょうどいいおカネの話収録予定',
                    'ちょうどいいごりごり隊収録予定',
                    'ビジネスアイ収録予定'
                ],
                'PRIME TIME': [
                    '19:41Traffic',
                    '19:43',
                    '20:51',
                    '営業コーナー',
                    '指定曲',
                    'ゲスト',
                    '時間指定なしパブ',
                    'ラジショピ',
                    '先行予約・限定予約',
                    'その他'
                ],
                'FLAG': [
                    '12:40電話パブ',
                    '13:29パブリシティ',
                    '13:40パブリシティ',
                    '12:15リポート案件',
                    '14:29リポート案件',
                    '時間指定なし告知',
                    '楽曲',
                    '先行予約',
                    'ゲスト',
                    'コーナー',
                    '放送終了後'
                ],
                'God Bless Saturday': [
                    'ゲスト',
                    'プレゼント',
                    'キリン',
                    'パークシティー',
                    'ヨコハマ',
                    '指定曲',
                    'プライムカッツ',
                    '14:41パブ',
                    '時間指定なしパブ',
                    '期間限定リポート',
                    'その他'
                ],
                'Route 847': [
                    'リポート16:47',
                    '営業パブ17:41',
                    '時間指定なし告知',
                    '指定曲',
                    '番宣スポット',
                    'そのほか'
                ]
            };

            // 番組名を取得
            const programName = result.programName;
            const orderedKeys = programKeyOrder[programName] || [];

            // データに存在するすべてのカテゴリを収集
            const allCategories = new Set();
            days.forEach(day => {
                Object.keys(weekData[day]).forEach(category => {
                    if (category !== '日付') {
                        allCategories.add(category);
                    }
                });
            });

            // 順序に従ってカテゴリを並べ、定義にないものは最後に追加
            const categories = [];
            orderedKeys.forEach(key => {
                if (allCategories.has(key)) {
                    categories.push(key);
                    allCategories.delete(key);
                }
            });
            // 定義にない残りのカテゴリを追加
            allCategories.forEach(category => {
                categories.push(category);
            });

            // テーブル生成
            let tableHTML = '<table class="program-table">';

            // ヘッダー行
            tableHTML += '<thead><tr><th class="category-cell">項目</th>';
            days.forEach(day => {
                const dayData = weekData[day];
                const dateStr = dayData['日付'] ? dayData['日付'][0] : '';
                const dayLabel = getDayLabel(day);
                tableHTML += `<th class="day-cell">${dayLabel}<br>${dateStr}</th>`;
            });
            tableHTML += '</tr></thead>';

            // ボディ行
            tableHTML += '<tbody>';
            categories.forEach(category => {
                if (category === '日付') return; // 日付行はスキップ

                tableHTML += '<tr>';
                tableHTML += `<td class="category-cell">${category}</td>`;

                days.forEach(day => {
                    const dayData = weekData[day];
                    const categoryData = dayData[category];

                    tableHTML += '<td class="day-cell">';
                    if (categoryData) {
                        tableHTML += formatCategoryData(category, categoryData);
                    } else {
                        tableHTML += 'ー';
                    }
                    tableHTML += '</td>';
                });

                tableHTML += '</tr>';
            });
            tableHTML += '</tbody>';

            tableHTML += '</table>';
            tableContainer.innerHTML = tableHTML;
        }

        function formatCategoryData(category, data) {
            if (!data || data.length === 0) {
                return 'ー';
            }

            // 楽曲・指定曲カテゴリの場合（オブジェクト配列の特別処理）
            if (category === '楽曲' || category === '指定曲') {
                if (Array.isArray(data) && data.length > 0 && typeof data[0] === 'object') {
                    return data.map(music => {
                        let html = '<div class="music-item">';
                        html += `<div class="music-title">${escapeHtml(music.曲名 || '')}</div>`;
                        if (music.URL) {
                            html += `<div class="music-url">${escapeHtml(music.URL)}</div>`;
                        }
                        if (music.付帯情報) {
                            html += `<div class="music-metadata">${escapeHtml(music.付帯情報)}</div>`;
                        }
                        html += '</div>';
                        return html;
                    }).join('');
                }
            }

            // 配列データの場合
            if (Array.isArray(data)) {
                if (data.length === 1) {
                    return escapeHtml(data[0]);
                }
                return '<ul class="item-list">' +
                    data.map(item => `<li>${escapeHtml(item)}</li>`).join('') +
                    '</ul>';
            }

            // その他
            return escapeHtml(String(data));
        }

        function getDayLabel(day) {
            const labels = {
                'monday': '月曜日',
                'tuesday': '火曜日',
                'wednesday': '水曜日',
                'thursday': '木曜日',
                'friday': '金曜日',
                'saturday': '土曜日',
                'sunday': '日曜日'
            };
            return labels[day] || day;
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function getWeekLabel(weekType) {
            const labels = {
                'thisWeek': '今週',
                'nextWeek': '1週先',
                'nextWeek2': '2週先',
                'nextWeek3': '3週先',
                'nextWeek4': '4週先'
            };
            return labels[weekType] || weekType;
        }

        function formatTimestamp(timestamp) {
            const date = new Date(timestamp);
            return date.toLocaleString('ja-JP', {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit'
            });
        }

        /**
         * 結果オブジェクトの weekData を曜日順にソート
         */
        function sortResultByDays(result) {
            if (!result.data || !result.data.weekData) {
                return result;
            }

            const dayOrder = ['monday', 'tuesday', 'wednesday', 'thursday', 'friday', 'saturday', 'sunday'];
            const weekData = result.data.weekData;
            const sortedWeekData = {};

            // 1. 曜日データを順番に追加
            dayOrder.forEach(day => {
                if (weekData[day]) {
                    sortedWeekData[day] = weekData[day];
                }
            });

            // 2. その他のキー（収録予定など）を追加
            Object.keys(weekData).forEach(key => {
                if (!dayOrder.includes(key)) {
                    sortedWeekData[key] = weekData[key];
                }
            });

            // ソート済みのweekDataで置き換え
            return {
                ...result,
                data: {
                    ...result.data,
                    weekData: sortedWeekData
                }
            };
        }

        // =============================================================================
        // PDF出力機能
        // =============================================================================

        /**
         * PDFをダウンロード
         */
        function downloadPDF() {
            if (!currentData || !currentData.success) {
                alert('番組データが読み込まれていません。先にデータを表示してください。');
                return;
            }

            // currentDataから番組名と週タイプを取得
            const programName = currentData.programName;
            const weekType = currentData.weekType;

            // デバッグログ
            console.log('[PDF] currentData:', currentData);
            console.log('[PDF] programName:', programName);
            console.log('[PDF] weekType:', weekType);

            if (!programName || !weekType) {
                alert('番組名または週タイプが取得できません。もう一度データを表示してください。');
                return;
            }

            const pdfBtn = document.getElementById('pdfDownloadBtn');
            const originalText = pdfBtn.textContent;

            // ボタンを無効化
            pdfBtn.disabled = true;
            pdfBtn.textContent = 'PDF生成中...';

            console.log('[PDF] PDF生成開始:', programName, weekType);

            // Google Apps ScriptのPDF生成関数を呼び出し
            google.script.run
                .withSuccessHandler(function(result) {
                    pdfBtn.disabled = false;
                    pdfBtn.textContent = originalText;

                    if (result.success) {
                        console.log('[PDF] PDF生成成功:', result.pdfUrl);

                        // 新しいタブでPDFを開く
                        window.open(result.pdfUrl, '_blank');

                        alert('PDFを生成しました。\n\nタイトル: ' + result.title + '\n\n新しいタブで開きます。');
                    } else {
                        console.error('[PDF] PDF生成エラー:', result.message);
                        alert('PDF生成エラー: ' + result.message);
                    }
                })
                .withFailureHandler(function(error) {
                    pdfBtn.disabled = false;
                    pdfBtn.textContent = originalText;
                    console.error('[PDF] 通信エラー:', error);
                    alert('PDF生成通信エラー: ' + error.message);
                })
                .generateProgramPDF(programName, weekType);
        }
    </script>
</body>
</html>
